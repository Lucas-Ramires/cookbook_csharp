<h1>Projeto 02 - Blog Pessoal - Classe PostagemController e PostagemService - M√©todo Atualizar Postagem</h1>



O que veremos por aqui:

1. Implementar o m√©todo Update(Postagem postagem) na Classe PostagemService
4. Criar o m√©todo Update(Postagem postagem) na Classe PostagemController
5. Testar os M√©todos no Insomnia

<br />

<h2>1. O Recurso Postagem</h2>



Nas etapas anteriores, come√ßamos a construir as Classes **PostagemService** e **PostagemController** e implementamos os seguintes M√©todos:

-  **GetAll()**  ü°™ Retorna todos os Objetos da Classe Postagem persistidos no Banco de dados.
-  **GetById(long id)** ü°™ Retorna um Objeto espec√≠fico da Classe Postagem persistido no Banco de dados. A Postagem √© identificada pelo atributo id. 
-  **GetByTitulo(string titulo)** ü°™ Retorna  todos os Objetos da Classe Postagem persistidos no Banco de dados, cujo atributo titulo contenha (em qualquer parte) a string enviada no par√¢metro titulo do M√©todo.   
-  **M√©todo Create(postagem: Postagem)** ü°™ Persiste (salva) um novo Objeto da Classe Postagem no Banco de dados.

Vamos continuar a constru√ß√£o das Classes **PostagemService** e  **PostagemController** implementando o M√©todo **Update(Postagem postagem)**, que atualizar√° um Objeto da Classe Postagem persistido no Banco de dados.

```mermaid
classDiagram
class Postagem {
  + Id : Long
  + Titulo : String
  + Texto: String
  + GetAll()
  + GetById(long id)
  + GetByTitulo(string titulo)
  + Create(Postagem postagem)
  + Update(Postagem postagem)
  + Delete(long id)
}
class Auditable {
  + Data: DateTimeOffset
}
Postagem --|> Auditable: Herda
```

<br />

<h2>üë£ Passo 01 - Criar o M√©todo create(Postagem postagem) na Classe PostagemService</h2>



Vamos implementar o M√©todo **Create(Postagem postagem)** na Classe PostagemService. Tra√ßando um paralelo com o SQL, seria o equivalente a instru√ß√£o: <code>UPDATE tb_postagens SET titulo = "titulo", texto = "texto", data = CURRENT_TIMESTAMP() WHERE id = id;</code>.

1. Abra a Classe **PostagemService**.

2. Insira o c√≥digo abaixo no M√©todo **Create(Postagem postagem)**.

<div align="left"><img src="https://i.imgur.com/QUfMrhl.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linhas 56 a 70:** Criamos o M√©todo Ass√≠ncrono (async), chamado **Update(Postagem postagem)**, que promete retornar uma **Promise** com **um** Objeto da Classe Postagem com os dados Atualizados. 

Note que a Classe **Task** recebe no par√¢metro Generic Type (<T>) o tipo Postagem, entretanto, ao lado do tipo foi adicionado uma interroga√ß√£o (**?**). Esta interroga√ß√£o indica que o Objeto Postagem, que ser√° retornado pelo M√©todo, pode ser nulo (null), caso ele n√£o seja persistido no Banco de dados.

Observe que o M√©todo **Update(Postagem postagem)** possui um par√¢metro do tipo **Postagem**, chamado **postagem**. Esta vari√°vel receber√° um Objeto da Classe Postagem, que foi enviado no Corpo da Requisi√ß√£o (Request Body), conforme as regras definidas na Entidade Postagem (Tamanho, Pode ser Nulo, Pode ser vazio, entre outras). O Objeto postagem ser√° enviado pelo M√©todo da **Classe PostagemController**, atrav√©s de um **JSON**, semelhante ao exemplo abaixo: 

```json
{
    "id" : 3,
    "titulo" : "Postagem 03",
    "texto" : "Texto da Postagem 03"
}
```

Observe que al√©m dos Atributos **titulo e texto**, no caso de uma atualiza√ß√£o, o **id tamb√©m deve ser enviado**. Desta forma, ser√° poss√≠vel identificar exatamente qual √© a postagem que ser√° atualizada. O atributo **data ser√° atribu√≠do pelo ASP.NET** (timestamp). Importante refor√ßar que ao atualizar a postagem, o atributo data tamb√©m ser√° atualizado.

> **Timestamp:** Basicamente representa um instante √∫nico, um ponto espec√≠fico na linha  do tempo, e seu valor corresponde a uma determinada quantidade de tempo decorrida a partir de um instante inicial. Dentro do nosso contexto, a aplica√ß√£o consultar√° o Sistema Operacional para obter a data e a hora e gravar√° em um Atributo do Objeto (data, por exemplo) o momento exato em que ele foi criado ou atualizado.

**Linha 59:** Criamos um Objeto da Classe postagem, chamado **PostagemUpdate**, que receber√° o resultado da execu√ß√£o do M√©todo **FindAsync(postagem.Id)**, da Interface **PostagemService**, que retorna apenas um Objeto espec√≠fico, cujo id seja igual ao valor do atributo **Id** do Objeto postagem. 

Observe que na istru√ß√£o acima foi inserido o comando **await** (aguarde), que na pr√°tica significa espere que a **Promise** seja resolvida (o Objeto Postagem seja encontrado), antes de retornar a execu√ß√£o do M√©todo e o valor resolvido.

**Linhas 61 a 62:** Verifica se o Objeto **PostagemUpdate** √© nulo. Caso seja nulo, o M√©todo retornar√° um Objeto nulo, indicando que a Postagem n√£o foi econtrada.

**Linha 64:** Retiramos o Objeto **PostagemUpdate** da lista de Objetos rastreados pelo **DbContext**, alterando o **State** (estado) do Objeto postagem para **EntityState.Detached**. Como o ASP.NET atualiza todos os Objetos rastreados de uma √∫nica vez e o Objeto Postagem Update foi utilizado apenas para checar se o Objeto que iremos atualizar (postagem) existe, precisamos retir√°-lo da lista de Objetos rastreados pelo **DbContext**, sen√£o ele entrar√° na lista de Objetos atualiz√°veis. 

**Linha 65:** Adicionamos o Objeto postagem na lista de Objetos rastreados pelo **DbContext**, que ser√£o atualizados, alterando o **State** (estado) do Objeto postagem para **EntityState.Modified**, at√© que eles sejam persistidos no Banco de dados.

**Linha 66:** O Objeto postagem √© persistido no Banco de dados com as atualiza√ß√µes, atrav√©s do M√©todo **SaveChangesAsync**.

Observe que na instru√ß√£o **SaveChangesAsync** foi inserido o comando **await** (aguarde), que na pr√°tica significa espere que a **Promise** seja resolvida (o Objeto postagem seja persistido).

**Linha 68:** Retorna o Objeto da Classe Postagem atualizado no Banco de dados, na tabela **tb_postagens**.  

No caso de uma atualiza√ß√£o dos dados, o retorno esperado do M√©todo **SaveChangesAsync** ser√° a confirma√ß√£o do Objeto persistido, no formato JSON, como mostra o exemplo abaixo:

```json
{
	"id": 3,
	"titulo": "Postagem 03 - Atualizado",
	"texto": "Texto da minha postagem 03 - Atualizado",
	"data": "2023-07-24T12:48:03.1494568-03:00"
}
```

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/system.threading.tasks.task-1?view=net-7.0" target="_blank"><b>Documenta√ß√£o: Task</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/csharp/asynchronous-programming/async-scenarios" target="_blank"><b>Documenta√ß√£o: Programa√ß√£o Ass√≠ncrona</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/csharp/asynchronous-programming/task-asynchronous-programming-model" target="_blank"><b>Documenta√ß√£o: Modelo de Tarefa Ass√≠ncrona</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/csharp/fundamentals/types/generics" target="_blank"><b>Documenta√ß√£o: Classes Gen√©ricas</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/system.data.entitystate?view=netframework-4.8.1" target="_blank"><b>Documenta√ß√£o: EntityState</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync?view=efcore-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo SaveChangesAsync</b></a></div>

<br />

<h2>üë£ Passo 02 - Criar o M√©todo Post(Postagem postagem) na Classe PostagemController</h2>



Vamos implementar o M√©todo **Post(Postagem postagem)** na Classe PostagemController, que tem como objetivo executar o M√©todo com o mesmo nome na Classe de Servi√ßo PostagemService. 

1. Abra a Classe **PostagemController**.

2. Insira o c√≥digo abaixo depois do M√©todo **Update(Postagem postagem)**.

<div align="left"><img src="https://i.imgur.com/THWiAKv.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linhas 62 a 80:** Criamos o M√©todo **Update(Postagem postagem)** como um **M√©todo Ass√≠ncrono**, atrav√©s da palavra reservada **async**, que promete retornar um Objeto **ActionResult**, contendo um Objeto da Classe Postagem atualizado no Banco de dados, recebido do **M√©todo Update(Postagem postagem) da Classe de Servi√ßo PostagemService**. 

**Linha 62:** A Anota√ß√£o **[HttpPut]** mapeia todas as Requisi√ß√µes **HTTP PUT**, enviadas para um endere√ßo espec√≠fico, chamado **endpoint**, dentro do Recurso Postagem, para um M√©todo espec√≠fico que responder√° a Requisi√ß√£o. No Projeto Blog Pessoal, ele indica que o M√©todo **Update(Postagem postagem)**, responder√° a todas as requisi√ß√µes do tipo **HTTP PUT**, enviadas para o endere√ßo **http://localhost:5000/postagens**. 

**Linha 63:** Observe que o M√©todo **Update(Postagem postagem)** possui na sua assinatura uma anota√ß√£o ao lado do par√¢metro **postagem**. A anota√ß√£o **[FromBody]** indica que o Objeto postagem ser√° recebido atrav√©s do Corpo da Requisi√ß√£o HTTP. Na pr√°tica, ser√° enviado atrav√©s de um JSON inserido no Corpo da Requisi√ß√£o.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** *O Endere√ßo do endpoint do M√©todo Update(Postagem postagem) ser√° igual ao endere√ßo dos M√©todos GetAll() e Create(Postagem postagem). Como os verbos HTTP dos dois M√©todos s√£o diferentes, o mesmo endere√ßo pode ser de utilizado.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

**Linhas 65 a 66:** Verifica se o atributo Id do Objeto **postagem** √© igual a zero. Caso seja zero, o M√©todo retornar√° o HTTP Status **BADREQUEST ü°™ 400**, atrav√©s do M√©todo **BadRequest()**.

**Linha 68:** Criamos um Objeto da Classe PostagemValidator, chamado **validarPostagem**, que receber√° o resultado da execu√ß√£o do M√©todo **ValidateAsync(postagem)**, da Classe **PostagemValidator**, que retorna a valida√ß√£o dos dados do Objeto postagem, de acordo com as regras de valida√ß√£o criadas na Classe PostagemValidator. 

**Linhas 70 a 71:** Verifica se o Objeto **postagemValidator** n√£o √© v√°lido, ou seja, se alguma regra n√£o foi validada. Caso n√£o seja v√°lido, o M√©todo **Update(Postagem postagem)** retornar√° o HTTP Status **BADREQUEST ü°™ 400** com a lista de erros de valida√ß√£o, atrav√©s do M√©todo **StatusCode()**.

**Linha 73:** Se o Objeto postagem for validado, criamos o Objeto **Resposta**, que receber√° a execu√ß√£o do M√©todo **Update(Postagem postagem)**, da Classe  **PostagemService**, respons√°vel por atualizar os dados do Objeto persistido no Banco de dados.

Observe que na instru√ß√£o **Update(Postagem postagem)** foi inserido o comando **await** (aguarde), que na pr√°tica significa espere que a **Promise** seja resolvida (o Objeto postagem seja persistido).

**Linhas 75 a 76:** Verifica se o Objeto **Resposta** √© nulo (null). Caso seja nulo, o M√©todo **Update(Postagem postagem)** retornar√° o HTTP Status **NOT FOUND ü°™ 404** (N√£o Encontrado!), atrav√©s do M√©todo **NotFound()**.

**Linha 78:** Caso a Postagem seja atualizada, retornaremos o Objeto **Resposta** atrav√©s do M√©todo **Ok()**. O M√©todo **Ok()** cria uma  **Resposta HTTP** padr√£o, com o HTTP Status **OK ü°™ 200**, e insere no Corpo da Resposta um JSON, contendo o Objeto Postagem atualizado. 

<br />

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Methods" target="_blank"><b>Documenta√ß√£o: HTTP Methods Request</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status" target="_blank"><b>Documenta√ß√£o: HTTP Status Code</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.aspnetcore.mvc.controllerbase?view=aspnetcore-7.0" target="_blank"><b>Documenta√ß√£o: Classe ControllerBase</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/aspnet/core/web-api/?view=aspnetcore-7.0" target="_blank"><b>Documenta√ß√£o: Criar APIs Web com o ASP.NET Core</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/aspnet/core/mvc/controllers/dependency-injection?view=aspnetcore-7.0" target="_blank"><b>Documenta√ß√£o: Inje√ß√£o de depend√™ncia em controladores</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.aspnetcore.mvc.actionresult?view=aspnetcore-7.0" target="_blank"><b>Documenta√ß√£o: Classe ActionResult</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.ok?view=aspnetcore-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo Ok()</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.notfound?view=aspnetcore-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo NotFound()</b></a></div>

<br />


<h2>üë£ Passo 03 - Executar o projeto</h2>



Para executarmos o Projeto, clique no bot√£o <img src="https://i.imgur.com/gPnfOVk.png" title="source: imgur.com" width="8%"/>**Run http**, na **Barra de Ferramentas Principal** (indicado em verde na imagem):

![Imagem 30](https://i.imgur.com/Ya4O50P.png)

<br />

<h2>üë£ Passo 04 - Testar no Insomnia o M√©todo update</h2>



Agora vamos criar a Requisi√ß√£o para o **M√©todo update(Postagem postagem)**:

1. Clique com o bot√£o direito do mouse sobre a **Pasta Postagem** para abrir o menu e clique na op√ß√£o **New Request**.

<div align="center"><img src="https://i.imgur.com/bFUVP3h.png" title="source: imgur.com" width="50%"/></div>

2.  Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Postagem**.

<div align="center"><img src="https://i.imgur.com/CA70WQn.png" title="source: imgur.com" /></div>

3. D√™ um duplo clique sobre a nova Requisi√ß√£o (**New Request**), informe o nome da Requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/ZQKmphk.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na Requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Postagem no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a Requisi√ß√£o conforme a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/xNTJCRr.png" title="source: imgur.com" /></div>

4. No item marcado em amarelo na imagem acima, informe o endere√ßo (endpoint)) da Requisi√ß√£o. A requisi√ß√£o **Atualizar Postagem** foi configurada da seguinte maneira:

   - A primeira parte do endere√ßo (http://localhost:5000) √© o endere√ßo do nosso servidor local. Quando a aplica√ß√£o estiver na nuvem, ele ser√° substitu√≠do pelo endere√ßo da nuvem (**Exemplo:** http://nomedaaplicacao.onrender.com).
   - A segunda parte do endere√ßo √© o **endpoint** configurado na anota√ß√£o **[Route("~/postagens")]**, em nosso caso **/postagens**.  
   
5. Na guia **JSON**, precisamos inserir um **JSON** com os dados que ser√£o inseridos na nova postagem. Lembrando que no padr√£o JSON: **o texto antes dos 2 pontos** (:) √© o **atributo** da Classe e **o texto depois dos 2 pontos** (:) √© o **dado** que ser√° cadastrado no atributo.  Os atributos s√£o separados por virgula, como mostra a imagem acima.

   | <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** Observe que no m√©todo **PUT √© necess√°rio enviar o atributo id** no JSON para identificar a Postagem que ser√° atualizada. A data n√£o precisa ser enviada, porqu√™ ela ser√° atualizada pela pr√≥pria aplica√ß√£o.</div> |
   | ------------------------------------------------------------ | ------------------------------------------------------------ |

6. Para testar a requisi√ß√£o, com a aplica√ß√£o rodando, clique no bot√£o <img src="https://i.imgur.com/sy0V8Nx.png" title="source: imgur.com" width="60px"/>.

7. O resultado da requisi√ß√£o voc√™ confere na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/JGV0jHG.png" title="source: imgur.com" /></div>

8. Observe que a aplica√ß√£o retorna al√©m dos dados que foram atualizados no Banco de dados, ela tamb√©m retorna um **HTTP Status 200 ü°™ OK** (indicado em verde na imagem acima). Este Status indica que a Requisi√ß√£o foi bem sucedida!

9. Caso a Postagem n√£o seja encontrada, ser√° retornado o **HTTP Status 404 ü°™ NOT_FOUND**, ou seja, a postagem n√£o foi encontrada, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/fqPcQy7.png" title="source: imgur.com" /></div>

10. Caso os Atributos **titulo** ou **texto** sejam nulos ou em branco (indicado em amarelo), a aplica√ß√£o retornar√° o **HTTP Status 400 ü°™ BAD_REQUEST** (indicado em verde), devido as valida√ß√µes que foram inseridas na Classe **PostagemValidator** **( NotEmpty e MinimumLength(5) )**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/jorM75G.png" title="source: imgur.com" /></div>

<br />

<div align="left"><img src="https://i.imgur.com/g1HCNZy.png" title="source: imgur.com" width="5%" /><a href="https://docs.insomnia.rest/" target="_blank"><b>Documenta√ß√£o: Insomnia Rest</b></a></div>

<div align="left"><img src="https://i.imgur.com/14IR5P4.png" title="source: imgur.com" width="5%"/><a href="https://www.json.org/json-pt.html" target="_blank"><b>Site Oficial do JSON</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="5%"/> <a href="" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>