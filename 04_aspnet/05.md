<h1>Projeto 02 - Blog Pessoal - Configurar o Banco de dados</h1>

O que veremos por aqui:

1. Configurar o Banco de dados
2. Executar a Aplica√ß√£o

<br />

<h2>üë£ Passo 01 - Configurar a Conex√£o com o Banco de dados</h2>



Diferente do Projeto Hello World, no Projeto Blog Pessoal vamos utilizar um Banco de dados para persistir os nossos Objetos, ou seja, gravar os dados dos Objetos como registros (linhas) nas Tabelas. 

Para come√ßar, vamos configurar a conex√£o com o Banco de dados **db_blogpessoal**.

A configura√ß√£o do Banco de dados ser√° implementada no arquivo **appsettings.json**, localizado na pasta **raiz** do projeto, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/tRvtnVi.png" title="source: imgur.com" /></div>

1. Abra o arquivo **appsettings.json**

<div align="center"><img src="https://i.imgur.com/SFeLNWy.png" title="source: imgur.com" /></div>

2. O conte√∫do do arquivo ser√° semelhante a imagem acima. 
2. Vamos adicionar o trecho de c√≥digo abaixo, que cont√©m a string de conex√£o com o Banco de dados SQL Server

```json
"ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Initial Catalog=db_blogpessoal;Trusted_Connection=True;TrustServerCertificate=true;MultipleActiveResultSets=True;"
  },
```

4. O conte√∫do do arquivo **appsettings.json** ficar√° se semelhante a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/ZWitAyo.png" title="source: imgur.com" /></div>

Vamos detalhar as altera√ß√µes realizadas:

**Linha 2:** Inserimos a propriedade **ConnectionStrings**, que se trata de um array, onde ficam armazenadas as Strings de Conex√£o com o(s) Banco(s) de dados. Dependendo do tamanho do sistema, ele pode se conectar com v√°rios Bancos de dados, em variados SGBD's. 

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a String de conex√£o com o Banco de dados. Cada SGBD, al√©m de possuir o seu pr√≥prio driver de conex√£o (pacote no contexto do ASP.NET), possui tamb√©m a sua pr√≥pria String de conex√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 3:** Inserimos a propriedade **DefaultConnection**, que armazenar√° as Strings de Conex√£o com o Banco de dados principal da aplica√ß√£o. Dentro da **String de Conex√£o do SQL Server**, n√≥s temos os seguintes atributos:

| Atributo                     | Descri√ß√£o                                                    |
| ---------------------------- | ------------------------------------------------------------ |
| **Server**                   | Indica o endere√ßo do servidor, Como estamos trabalhando localmente, podemos utilizar **localhost** (equivalente a m√°quina locala - 127.0.0.1) ou podemos utilizar o nome da m√°quina (hostname). Para consultar o nome da sua m√°quina, abra o Terminal e digite o comando `hostname`. |
| **Initial Catalog**          | Indica o nome do Banco de dados da aplica√ß√£o. Em nosso projeto, o banco se chama **db_blogpessoal**. |
| **Trusted_Connection**       | Esta configura√ß√£o especifica que a conex√£o deve utilizar o usu√°rio e a senha do Banco de dados na string de conex√£o para fazer login na inst√¢ncia do SQL Server ou as credenciais atuais da conta do Windows. Em nosso exemplo, estamos utilizando as credenciais do Windows (seu usu√°rio e a sua senha de acesso ao Windows) |
| **TrustServerCertificate**   | Esta configura√ß√£o indica que o SSL (Security Sockets Layer) ser√° usado para criptografar o canal ao ignorar a movimenta√ß√£o da cadeia de certificados para validar a confian√ßa. Caso esta configura√ß√£o n√£o seja habilitada, o ASP.NET retornar√° um erro de valida√ß√£o do Certificado do Servidor de Banco de dados. |
| **MultipleActiveResultSets** | A op√ß√£o MultipleActiveResultSets (MARS) possibilita a execu√ß√£o de m√∫ltiplas consultas simultaneamente. Este √© um cen√°rio comum ao usar o Entity Framework, especialmente porque utilizaremos M√©todos Ass√≠ncronos. |

<br />

> SSL **√© a sigla  para Secure Sockets Layer, uma ferramenta de seguran√ßa digital usada  para comunicar sites e navegadores de forma criptografada**. √â ela a  respons√°vel por modificar os endere√ßos dos sites de HTTP para HTTPS, o  que indica que oferecem comunica√ß√£o segura com o servidor.

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/previous-versions/aspnet/jj653752(v=vs.110)" target="_blank"><b>Documenta√ß√£o: Connection String.</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/system.data.sqlclient.sqlconnection.connectionstring?view=dotnet-plat-ext-6.0" target="_blank"><b>Documenta√ß√£o: Propriedades da Connection String</b></a></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="200px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a String de Conex√£o com o Banco de dados no arquivo appsettings.json, especialmente com o nome do Banco de dados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>Observa√ß√µes importantes:</h2>

- O Nome do banco de dados deve seguir o padr√£o **db_nome_do_banco**. O prefixo **db** indica que se trata de um Database (Banco de dados). O nome do banco √© recomendado que seja **o mesmo do projeto** (blogpessoal), em **letras min√∫sculas**, **sem espa√ßos em branco ou caracteres especiais e acentos**. Para separar as palavras em um nome composto, utilize o _ (underline). **Exemplo:** db_blog_pessoal.
- O endere√ßo **localhost** √© o endere√ßo local, ou seja, o seu pr√≥prio computador. Quando a aplica√ß√£o estiver na nuvem, o endere√ßo do Banco de dados ser√° alterado para um endere√ßo remoto.
- Vale ressaltar que no mercado de trabalho, em uma aplica√ß√£o em produ√ß√£o, o usu√°rio do servidor n√£o ter√° acesso total ao Banco de dados, da mesma forma que temos no ambiente local. O DBA (Database Administrator - Pessoa Administradora do Banco de dados) ou o Lead do seu time de Desenvolvedores, far√° as devidas configura√ß√µes do seu usu√°rio no servidor, limitando o seu acesso ao SQL Server, autorizando apenas o necess√°rio para que a aplica√ß√£o funcione.

<br />

<h2>üë£ Passo 02 - Configurar o Contexto do Banco de dados</h2>



Dentro do projeto **blogpessoal**, vamos criar a pasta **Data**:

1. No lado direito superior, na Guia **Gerenciador de Solu√ß√µes**, clique com o bot√£o direito do mouse sobre o projeto  **blogpessoal** e clique na op√ß√£o **Adicionar ü°™ Nova Pasta**

2. Digite o nome da pasta (**Data**), com a primeira letra mai√∫scula, seguindo o padr√£o do C# e pressione **enter** para concluir. O Gerenciador de Solu√ß√µes da aplica√ß√£o ficar√° semelhante a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/FnmyvL8.png" title="source: imgur.com" /></div>

Na sequ√™ncia, vamos criar a **Classe AppDbContext** na pasta **Data**.

1. Clique com o bot√£o direito do mouse sobre a **pasta Data** e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Classe**
2. Na janela **Adicionar Novo item**, no item **Nome**, digite o nome da Classe (**AppDbContext**), como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/WZxQXIU.png" title="source: imgur.com" /></div>

3. Clique no bot√£o **Adicionar** para concluir.
4. O Gerenciador de Solu√ß√µes da aplica√ß√£o ficar√° semelhante a imagem abaixo:

 <div align="center"><img src="https://i.imgur.com/18tmbf2.png" title="source: imgur.com" /></div>

Vamos implementar e analisar o c√≥digo da **Classe AppDbContext**:

 <div align="left"><img src="https://i.imgur.com/uabBw67.png" title="source: imgur.com" /></div>

**Linha 01:** Importamos o Namespace do **Entity Famework Core**.

**Linha 05:** Implementamos a Classe AppDbContext como Heran√ßa da Classe DbContext.

**Linhas 07 a 10:** Criamos o M√©todo Construtor da Classe AppDbContext com o par√¢metro **options**, herdado da Classe **DbContext**. O Par√¢metro **options** receber√° a Conex√£o com o Banco de dados, que a Classe AppDbContext ir√° interagir.

<br />

<h3>A Classe Db Context</h3>



O **Entity  Framework** permite consultar, inserir, atualizar e excluir dados (CRUD), utilizando objetos  **CLR(Common Language Runtime)** do C#, conhecidos como Entidades ou Models, que s√£o as Classes que definem os modelos de dados da aplica√ß√£o. Na pr√°tica, ele mapeia todas as Entidades e Relacionamentos que s√£o definidos no seu Modelo para um Banco de Dados Relacional e fornece todas as facilidades para realizar as seguintes tarefas: 

- Materializar dados retornados do banco de dados como objetos de entidade; 

- Controlar todas as altera√ß√µes que foram feitas nos objetos;

- Lidar com concorr√™ncia (Quando m√∫ltiplos usu√°rios tentam efetuar uma altera√ß√£o nos dados de sua aplica√ß√£o ao mesmo tempo); 

- Propagar no banco de dados todas as altera√ß√µes feitas nos objetos; 

- Vincular objetos a controles.

A principal classe respons√°vel pela intera√ß√£o com os objetos de dados √© a classe **DbContext**, conhecida como **contexto** do Banco de dados. 

Essa classe de contexto administra os objetos entidades durante o tempo de  execu√ß√£o, o que inclui preencher objetos com dados de um banco de dados,  controlar as altera√ß√µes e persistir dados no banco de dados.

A maneira mais recomendada para trabalhar com o contexto √© definir uma classe que herda a Classe  **DbContext** e exp√µe as propriedades de **DbSet** que representam as cole√ß√µes das entidades especificadas no contexto. No pr√≥ximo conte√∫do, vamos criar a nossa primeira Classe Model e trabalharemos com a Classe **DbSet**.

O tempo de  vida do contexto come√ßa quando a inst√¢ncia √© criada e termina quando a inst√¢ncia ou √© descartada ou √© removida pela **Garbage Collector**.

Por padr√£o, o  contexto gerencia as conex√µes com o Banco de dados e por isso enviamos a conex√£o com o Banco de dados, atrav√©s do par√¢metro **options**. Desta forma, o contexto abre e fecha as conex√µes conforme necess√°rio. Por exemplo, o Contexto abre uma conex√£o para executar uma consulta, e fecha a conex√£o quando todos os resultados da consulta foram processados.

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/system.data.entity.dbcontext?view=entity-framework-6.2.0" target="_blank"><b>Documenta√ß√£o: DbContext</b></a></div>

<br />

<h2>üë£ Passo 03 - Registrar o Contexto do Banco de dados</h2>



Vamos registrar o contexto do Banco de dados da nossa aplica√ß√£o, como um servi√ßo na Classe **Program**:

1. Abra a Classe **Program**;
2. Adicione no inicio da Classe **Program** as importa√ß√µes do pacote **Entity Framework Core** e do Namespace **Data** (pasta Data do projeto Blog Pessoal), atrav√©s da palavra reservada **using**, como mostra a imagem abaixo:

 <div align="left"><img src="https://i.imgur.com/xV7ojR2.png" title="source: imgur.com" /></div>

3. Localize a linha indicada abaixo:

 <div align="left"><img src="https://i.imgur.com/pXmfrxV.png" title="source: imgur.com" /></div>

4. Ap√≥s a linha indicada acima, adicione o trecho de c√≥digo abaixo:

```c#
// Conex√£o com o Banco de dados
            var connectionString = builder.Configuration.
                    GetConnectionString("DefaultConnection");

            builder.Services.AddDbContext<AppDbContext>(options =>
                options.UseSqlServer(connectionString)
            );
```

5. Vamos entender o trecho de c√≥digo acima:

 <div align="left"><img src="https://i.imgur.com/h5OfWEs.png" title="source: imgur.com" /></div>

**Linha 18:** Criamos a vari√°vel **connectionString**, que receber√° a String de conex√£o com o Banco de dados, que foi inserida no arquivo **appsettings.json**. O M√©todo **GetConnectionString()**, l√™ o arquivo **appsettings.json** em busca do atributo **DefaultConnection** e armazena o conte√∫do da propriedade (String de conex√£o com o Banco de dados), na vari√°vel **connectionString**.

**Linha 21:** Atrav√©s do M√©todo **AddDbContext**, estamos registrando a Classe **AppDbContext** como um servi√ßo de contexto de Banco de dados. Como par√¢metro, estamos enviando o objeto **options**, que recebe a conex√£o com o Banco de dados SQL Server, criada atrav√©s do M√©todo **UseSqlServer**, que recebeu como par√¢metro a vari√°vel **connectionString**.

Caso seja utilizado um outro SGBD, al√©m de instalar o pacote com o Driver do Banco de dados, o M√©todo de cria√ß√£o da conex√£o tamb√©m ser√° outro. **Exemplo:** Para criar uma conex√£o com o Postgres, o pacote com o Driver do Postgres oferece o M√©todo **UseNpgsql()**.

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.extensions.configuration.configurationextensions.getconnectionstring?view=dotnet-plat-ext-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo GetConnectionString()</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkservicecollectionextensions.adddbcontext?view=efcore-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo AddDbContext()</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.entityframeworkcore.sqlserverdbcontextoptionsextensions.usesqlserver?view=efcore-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo UseSqlServer()</b></a></div>

<br />

6. Localize a linha indicada abaixo:

 <div align="left"><img src="https://i.imgur.com/FrhZBnE.png" title="source: imgur.com" /></div>

7. Ap√≥s a linha indicada acima, adicione o trecho de c√≥digo abaixo:

```c#
 			// Criar o Banco de dados e as tabelas Automaticamente
            using (var scope = app.Services.CreateAsyncScope())
            {
                var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                dbContext.Database.EnsureCreated();
            }

            app.UseDeveloperExceptionPage();
```

8. Vamos entender o trecho de c√≥digo acima:

 <div align="left"><img src="https://i.imgur.com/gr26Vw8.png" title="source: imgur.com" /></div>

**Linha 45:** Cria um Escopo Ass√≠ncrono dentro da aplica√ß√£o, atrav√©s do M√©todo **CreateAsyncScope()**. A palavra reservada **using** tem a fun√ß√£o de instanciar o Escopo Ass√≠ncrono.

> **Escopo Ass√≠ncrono (Async Scope)** √© um bloco de processamento de ramifica√ß√£o, que √© executado simultaneamente com o fluxo principal da aplica√ß√£o. O fluxo principal continua a ser executado enquanto inicia e processa o Escopo Ass√≠ncrono em segundo plano. O fluxo principal n√£o precisa pausar at√© que o √∫ltimo processador de mensagem incorporado no fluxo ass√≠ncrono tenha conclu√≠do sua tarefa.
>
> Escopo Ass√≠ncrono √© muito √∫til para executar opera√ß√µes demoradas que n√£o exigem que voc√™ envie uma resposta de volta ao fluxo inicial (como imprimir um arquivo ou conectar-se a um servidor de e-mail). Em nosso exemplo, vamos utilizar o Escopo Ass√≠ncrono para conectar com o Banco de dados.

**Linha 47:** Cria a vari√°vel **dbContext**, que receber√° o Servi√ßo de contexto da aplica√ß√£o (**AppDbContext**), atrav√©s do M√©todo **GetRequiredService<AppDbContext>()**

**Linha 48:** Cria o Banco de dados e todas as Tabelas registradas no contexto, atrav√©s do M√©todo **EnsureCreated()**.

Por enquanto, a nossa aplica√ß√£o ir√° criar apenas o Banco de dados. Depois que implementarmos as Classes Model, o M√©todo **EnsureCreated()** criar√° as tabelas tamb√©m. Um ponto de aten√ß√£o importante √© como este M√©todo funciona na pr√°tica:

-  Se o banco de dados existir e possuir tabelas, nenhuma a√ß√£o ser√°  tomada. Nada √© feito para garantir que o esquema de banco de dados seja  compat√≠vel com o modelo do Entity Framework, ou seja, para criar novas tabelas ser√° necess√°rio apagar o banco de dados (DROP), para que o M√©todo **EnsureCreated()** crie o Banco e todas as tabelas.
-  Se o banco de  dados existir, mas n√£o tiver tabelas, o modelo do Entity Framework ser√°  usado para criar o esquema de banco de dados, ou seja, ele vai criar todas as tabelas referentes as Entidades registradas no contexto.
-  Se o banco de  dados n√£o existir, o banco de dados ser√° criado e o modelo do Entity  Framework ser√° usado para criar o esquema de banco de dados, ou seja, ele vai criar o Banco de dados e todas as tabelas referentes as Entidades registradas no contexto. 

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.extensions.dependencyinjection.serviceproviderserviceextensions.createasyncscope?view=dotnet-plat-ext-7.0" target="_blank"><b>Documenta√ß√£o: Escopo Ass√≠ncrono</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.extensions.dependencyinjection.serviceproviderserviceextensions.createasyncscope?view=dotnet-plat-ext-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo CreateAsyncScope()</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/dotnet/api/microsoft.entityframeworkcore.infrastructure.databasefacade.ensurecreated?view=efcore-7.0" target="_blank"><b>Documenta√ß√£o: M√©todo EnsureCreated()</b></a></div>

<br />

<h2>üë£ Passo 04 - Executar a aplica√ß√£o</h2>



1. Para executarmos o Projeto, clique no bot√£o <img src="https://i.imgur.com/gPnfOVk.png" title="source: imgur.com" width="8%"/>**Run http**, na **Barra de Ferramentas Principal** (indicado em verde na imagem):

![Imagem 30](https://i.imgur.com/Ya4O50P.png)

2. Observe que na janela do Terminal do Windows, que ser√° aberta durante a execu√ß√£o, √© poss√≠vel visualizar que o Banco de dados foi criado, como mostra a imagem abaixo:

![Imagem 31](https://imgur.com/BL44LuQ.png)

3. Para confirmar a cria√ß√£o do Banco de dados, abra o **SQL Server Management Studio** e conecte-se com o **SQL Server**, atrav√©s da tela abaixo:

<div align="center"><img src="https://i.imgur.com/ue0tGWa.png" title="source: imgur.com" /></div>

4. Para visualizar se o **Banco de Dados db_blogpessoal** foi criado, na janela **Pesquisador de Objetos**, localizada no lado esquerdo da tela, selecione o servidor <img src="https://i.imgur.com/Uz7gUN4.png" title="source: imgur.com" />**localhost** e clique no bot√£o **Atualizar** <img src="https://i.imgur.com/w0H9RB6.png" title="source: imgur.com" />.

<div align="center"><img src="https://i.imgur.com/ij7yMYl.png" title="source: imgur.com" /></div>

5. Na mesma janela, clique no sinal de (**+**) ao lado do item **Banco de Dados** e se tudo deu certo, veremos o **Banco de Dados db_blogpessoal** criado, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/zOELRog.png" title="source: imgur.com" width="50%"/></div>

6. Para interromper a execu√ß√£o do Projeto, clique no bot√£o <img src="https://i.imgur.com/E2e1u9C.png" title="source: imgur.com" width="4%"/>**Parar Depura√ß√£o**, na **Barra de Ferramentas Principal** (indicado em verde na imagem). Outra forma de parar a execu√ß√£o da aplica√ß√£o √© fechando a janela do Console ou do Navegador.

![Imagem 30](https://i.imgur.com/lJayMro.png)

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="5%"/> <a href="" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>