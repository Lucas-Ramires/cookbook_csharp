<h1>Projeto 02 - Blog Pessoal - Teste de Software - xUnit - Teste da Camada User</h1>



Vamos implementar os M√©todos de Teste da aplica√ß√£o:

<br />

<h2>üë£ Passo 01 - Criar a Classe ControllerTest no Projeto Blog Pessoal Test</h2>



Dentro do projeto **blogpessoaltest**, vamos criar a pasta **Controller**:

1. No lado direito superior, na Guia **Gerenciador de Solu√ß√µes**, clique com o bot√£o direito do mouse sobre o projeto  **blogpessoaltest** e clique na op√ß√£o **Adicionar ü°™ Nova Pasta**
2. Digite o nome da pasta (**Controller**), com a primeira letra mai√∫scula, seguindo o padr√£o do C# e pressione **enter** para concluir. O Gerenciador de Solu√ß√µes da aplica√ß√£o ficar√° semelhante a imagem abaixo:

Vamos criar a **Classe UserControllerTest** na pasta **Controller**:

1. Clique com o bot√£o direito do mouse sobre a **pasta Controller**, do projeto **blogpessoaltest** e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Classe**.
2. No item **Nome**, digite o nome da Classe (**UserControllerTest**)

Antes de come√ßar a implementar os M√©todos de teste, vamos criar as Inje√ß√µes de Depend√™ncia, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/pYkfAoO.png" title="source: imgur.com" /></div>

**Linhas 01 a 10:** Faz a importa√ß√£o dos Pacotes e Namespaces necess√°rios.

**Linha 15:** Insere a anota√ß√£o **[Order(1)]** acima da Classe, indicando que esta ser√° a primeira Classe de Testes, que ser√° executada.

**Linha 16:** Foi criada a Classe **UserControllerTest** como uma Heran√ßa da Classe **IClassFixture**, que recebe como par√¢metro a Classe `WebAppFactory<Program>`, que ser√° utilizada para executar os testes E2E. 

As Classe de Testes **UserControllerTest** implementar√° a interface **IClassFixture**, que utilizar√° o contexto de testes da aplica√ß√£o, que utiliza o Banco de dados em mem√≥ria.

**Linha 19:** Cria um Objeto da Classe **HttpClient**, que fornece m√©todos de teste, que geram Requisi√ß√µes HTTP.

**Linha 21:**  Cria um atributo do tipo string, chamado **Id**, que ser√° utilizado nos testes.

**Linhas 23 a 27:** Cria o M√©todo Construtor, que recebe o par√¢metro chamado **factory**, do tipo `WebAppFactory<Program>`.

**Linha 25:** Atribui ao Objeto **_client** uma inst√¢ncia da Classe **HttpClient**, criando uma Inje√ß√£o de Depend√™ncia. A partir desta Inje√ß√£o, construiremos as Requisi√ß√µes para testar a aplica√ß√£o.

<br />

<h3>M√©todo Auxiliar - Gerar Fake Token</h3>

<br />

<div align="center"><img src="https://i.imgur.com/oY3hA0H.png" title="source: imgur.com" /></div>

Neste M√©todo, copiamos o trecho de c√≥digo respons√°vel por Gerar o Token JWT da Classe **AuthService** e ajustamos para sempre gerar um Token para o usu√°rio **root@root.com.br**.

<br />

<h3>M√©todo 01 - Deve Criar Novo Usu√°rio</h3>

<br />

<div align="center"><img src="https://i.imgur.com/7Pjsm8K.png" title="source: imgur.com" /></div>

**Linha 52:** Insere a anota√ß√£o **[Fact, Order(1)]** acima do M√©todo de testes, indicando que ser√° um teste do tipo **Fact** e a ordem em que ele ser√° ser√° executado.

> **Fact** √© um tipo de teste que afirma que o m√©todo que escrevemos deve ser executado e que n√£o enviaremos nenhum par√¢metro para o m√©todo de teste.

**Linha 53:** Cria o M√©todo que executar√° o Teste **Deve Criar Novo Usuario**.

**Linha 56:** Define os dados do Objeto Usuario que ser√° enviado no Corpo da Requisi√ß√£o, atrav√©s do M√©todo **SendAsync()**. Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **POST**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body). Observe que o Objeto foi criado dentro de uma **Collection Dictionary**, chamada **novoUsuario**.

**Linha 64:** Cria um Objeto chamado **corpoRequisicao**, que receber√° o Objeto Dictionary convertido para o formato JSON.

**Linha 66:** Cria uma Requisi√ß√£o do tipo **POST**.

**Linha 75:** Foi criado um Objeto chamado **respostaPost**, que receber√° o resultado da Requisi√ß√£o, enviada pelo M√©todo **SendAsync()**.

**Linha 77:** Atrav√©s do m√©todo <b>Assert.Equal()</b>, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**CREATED ü°™ 201**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 201, o **Teste Passa**. Caso seja outro HTTP Status, o **Teste Falha**.

<br />

<h3>M√©todo 02 - N√£o Deve Criar Usu√°rio Duplicado</h3>

<br />

<div align="center"><img src="https://i.imgur.com/j1KZ0ib.png" title="source: imgur.com" /></div>

**Linha 81:** Insere a anota√ß√£o **[Fact, Order(2)]** acima do M√©todo de testes, indicando que ser√° um teste do tipo **Fact** e a ordem em que ele ser√° ser√° executado.

**Linha 82:** Cria o M√©todo que executar√° o Teste **Nao Deve Criar Usuario Duplicado**.

**Linha 84:** Define os dados do Objeto Usuario que ser√° enviado no Corpo da Requisi√ß√£o, atrav√©s do M√©todo **SendAsync()**. Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **POST**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body). Observe que o Objeto foi criado dentro de uma **Collection Dictionary**, chamada **novoUsuario**.

**Linha 92:** Cria um Objeto chamado **corpoRequisicao**, que receber√° o Objeto Dictionary convertido para o formato JSON.

**Linha 96:** Cria uma Requisi√ß√£o do tipo **POST**.

**Linha 105:** Envia a Requisi√ß√£o atrav√©s do M√©todo **SendAsync()**.

**Linha 109:** Cria uma nova Requisi√ß√£o do tipo **POST** com o mesmo conte√∫do da anterior, chamada **requisicaoPostDuplicada**. Essa Requisi√ß√£o simular√° a tentativa de criar um usu√°rio que j√° existe.

<br />

| <img src="https://i.imgur.com/nSpXEZ0.png" title="source: imgur.com" width="250px"/> | <p align="justify"> Observe que neste m√©todo temos o objetivo de testar o Erro! (Usu√°rio Duplicado) e n√£o a persist√™ncia dos dados. Por este motivo enviamos o mesmo objeto que foi enviado no primeiro teste e verificaremos se o aplicativo rejeita a persist√™ncia do mesmo objeto pela segunda vez (BAD REQUEST). </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 118:** Foi criado um Objeto chamado **respostaPost**, que receber√° o resultado da Requisi√ß√£o **requisicaoPostDuplicada**, enviada pelo M√©todo **SendAsync()**.

**Linha 120:** Atrav√©s do m√©todo <b>Assert.Equal()</b>, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**BAD_REQUEST ü°™ 400**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 400, o **Teste Passa**. Caso seja outro HTTP Status, o **Teste Falha**.

Como o teste tem por objetivo checar se est√° duplicando usu√°rios no Banco de dados, ao inv√©s de checarmos se o objeto foi persistido (**CREATE ü°™ 201**), checaremos se ele n√£o foi persistido (**BAD_REQUEST ü°™ 400**). 

<br />

<h3>M√©todo 03 - Deve Atualizar Usu√°rio</h3>

<br />

<div align="center"><img src="https://imgur.com/CqiZeaz.png" title="source: imgur.com" /></div>

**Linha 124:** Insere a anota√ß√£o **[Fact, Order(3)]** acima do M√©todo de testes, indicando que ser√° um teste do tipo **Fact** e a ordem em que ele ser√° ser√° executado.

**Linha 125:** Cria o M√©todo que executar√° o Teste **Deve Atualizar Usuario**.

**Linha 127:** Define os dados do Objeto Usuario que ser√° enviado no Corpo da Requisi√ß√£o, atrav√©s do M√©todo **SendAsync()**. Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **POST**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body). Observe que o Objeto foi criado dentro de uma **Collection Dictionary**, chamada **novoUsuario**.

**Linha 135:** Cria um Objeto chamado **corpoRequisicaoCriar**, que receber√° o Objeto Dictionary convertido para o formato JSON.

**Linha 139:** Cria uma Requisi√ß√£o do tipo **POST**.

**Linha 148:** Foi criado um Objeto chamado **respostaPost**, que receber√° o resultado da Requisi√ß√£o, enviada pelo M√©todo **SendAsync()**.

**Linhas 152 a 155:** Verifica se a Reposta da Requisi√ß√£o n√£o √© nula. Se esta condi√ß√£o for verdadeira, guardaremos o atributo **Id** do Objeto persistido no atributo **Id** da Classe **UserControllerTest**.

**Linha 159:** Define os dados atualizados do Objeto Usuario que ser√° enviado no Corpo da Requisi√ß√£o, incluindo o **Id**, atrav√©s do M√©todo **SendAsync()**. Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **PUTT**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body). Observe que o Objeto foi criado dentro de uma **Collection Dictionary**, chamada **atualizarUsuario**.

**Linha 168:** Cria um Objeto chamado **corpoRequisicaoAtualizar**, que receber√° o Objeto Dictionary convertido para o formato JSON.

**Linha 170:** Cria uma Requisi√ß√£o do tipo **PUT**.

**Linha 179:** Como o endpoint (**/usuarios/atualizar**) est√° protegido pelo **Token JWT**, precisamos enviar o token de um usu√°rio v√°lido no cabe√ßalho da Requisi√ß√£o, atrav√©s do M√©todo **DefaultRequestHeaders.Add()**. Como criamos o M√©todo **GerarFakeToken()**, para criar o token do usu√°rio Root, vamos chamar este M√©todo no par√¢metro **Authorization** do Cabe√ßalho (Header) da Requisi√ß√£o, que ser√° adicionado pelo M√©todo **DefaultRequestHeaders.Add**.

**Linha 180:** Foi criado um Objeto chamado **respostaPut**, que receber√° o resultado da Requisi√ß√£o, enviada pelo M√©todo **SendAsync()**.

**Linha 182:** Atrav√©s do m√©todo <b>Assert.Equal()</b>, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**OK ü°™ 200**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 200, o **Teste Passa**. Caso seja outro HTTP Status, o **Teste Falha**.

<br />

<h3>M√©todo 04 - Deve Listar todos os Usu√°rios</h3>

<br />

<div align="center"><img src="https://i.imgur.com/bJsIwe8.png" title="source: imgur.com" /></div>

**Linha 186:** Insere a anota√ß√£o **[Fact, Order(4)]** acima do M√©todo de testes, indicando que ser√° um teste do tipo **Fact** e a ordem em que ele ser√° ser√° executado.

**Linha 187:** Cria o M√©todo que executar√° o Teste **Deve Listar Todos Os Usuarios**.

**Linha 190:** Como o endpoint (**/usuarios/all**) est√° protegido pelo **Token JWT**, precisamos enviar o token de um usu√°rio v√°lido no cabe√ßalho da Requisi√ß√£o, atrav√©s do M√©todo **DefaultRequestHeaders.Add()**. Como criamos o M√©todo **GerarFakeToken()**, para criar o token do usu√°rio Root, vamos chamar este M√©todo no par√¢metro **Authorization** do Cabe√ßalho (Header) da Requisi√ß√£o, que ser√° adicionado pelo M√©todo **DefaultRequestHeaders.Add**.

**Linha 191:** Foi criado um Objeto chamado **respostaGet**, que receber√° o resultado da Requisi√ß√£o, enviada pelo M√©todo **SendAsync()**. Por se tratar de uma Requisi√ß√£o do tipo **GET** n√£o ser√° enviado nenhum Objeto no Corpo da Requisi√ß√£o.

**Linha 193:** Atrav√©s do m√©todo <b>Assert.Equal()</b>, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**OK ü°™ 200**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 200, o **Teste Passa**. Caso seja outro HTTP Status, o **Teste Falha**.

<br />

Abaixo voc√™ confere a vers√£o final da Classe **UserControllerTest**:

<br />

```c#
using blogpessoal.Model;
using blogpessoal.Security;
using blogpessoaltest.Helper;
using Microsoft.IdentityModel.Tokens;
using Newtonsoft.Json;
using System.IdentityModel.Tokens.Jwt;
using System.Net.Http.Json;
using System.Security.Claims;
using System.Text;
using Xunit.Extensions.Ordering;

namespace blogpessoaltest.Controllers
{

    [Order(1)]
    public class UserControllerTest : IClassFixture<WebAppFactory<Program>>
    {

        private readonly HttpClient _client;

        private string Id { get; set; } = string.Empty;

        public UserControllerTest(WebAppFactory<Program> factory)
        {
            
            _client = factory.CreateClient();

        }

        public static string GerarFakeToken()
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var tokenKey = Encoding.UTF8.GetBytes(Settings.Secret);
            var tokenDescriptor = new SecurityTokenDescriptor

            {
                Subject = new ClaimsIdentity(new Claim[]
                {
                    new Claim(ClaimTypes.Name, "root@root.com.br")
                }),
                Expires = DateTime.UtcNow.AddHours(1),
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(tokenKey), 
                                                            SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);

            return "Bearer " + tokenHandler.WriteToken(token).ToString();

        }

        [Fact, Order(1)]
        public async Task DeveCriarNovoUsuario()
        {

            var novoUsuario = new Dictionary<string, string>
            {
                { "nome", "Root" },
                { "usuario", "root@root.com.br" },
                { "senha", "rootroot" },
                { "foto", "-" }
            };

            var corpoRequisicao = JsonConvert.SerializeObject(novoUsuario);

            var requisicaoPost = new HttpRequestMessage(HttpMethod.Post, "/usuarios/cadastrar")
            {
                Content = new StringContent(
                corpoRequisicao,
                Encoding.UTF8,
                "application/json"
                )
            };

            var respostaPost = await _client.SendAsync(requisicaoPost);

            Assert.Equal(201, (int)respostaPost.StatusCode);

        }

        [Fact, Order(2)]
        public async Task NaoDeveCriarUsuarioDuplicado()
        {
            var novoUsuario = new Dictionary<string, string>
            {
                { "nome", "Juliana Andrews" },
                { "usuario", "juliana@email.com.br" },
                { "senha", "12345678" },
                { "foto", "-" }
            };

            var corpoRequisicao = JsonConvert.SerializeObject(novoUsuario);

            //Enviar a primeira vez

            var requisicaoPost = new HttpRequestMessage(HttpMethod.Post, "/usuarios/cadastrar")
            {
                Content = new StringContent(
                corpoRequisicao,
                Encoding.UTF8,
                "application/json"
                )
            };

            await _client.SendAsync(requisicaoPost);

            //Enviar a segunda vez

            var requisicaoPostDuplicada = new HttpRequestMessage(HttpMethod.Post, "/usuarios/cadastrar")
            {
                Content = new StringContent(
                corpoRequisicao,
                Encoding.UTF8,
                "application/json"
                )
            };

            var respostaPost = await _client.SendAsync(requisicaoPostDuplicada);

            Assert.Equal(400, (int)respostaPost.StatusCode);

        }

        [Fact, Order(3)]
        public async Task DeveAtualizarUsuario()
        {
            var criarUsuario = new Dictionary<string, string>
            {
                { "nome", "Paulo Antunes" },
                { "usuario", "paulo@email.com.br" },
                { "senha", "12345678" },
                { "foto", "-" }
            };

            var corpoRequisicaoCriar = JsonConvert.SerializeObject(criarUsuario);

            //Criar usu√°rio

            var requisicaoPost = new HttpRequestMessage(HttpMethod.Post, "/usuarios/cadastrar")
            {
                Content = new StringContent(
                corpoRequisicaoCriar,
                Encoding.UTF8,
                "application/json"
                )
            };

            var respostaPost = await _client.SendAsync(requisicaoPost);

            var corpoRespostaPost = await respostaPost.Content.ReadFromJsonAsync<User>();

            if (corpoRespostaPost is not null)
            {
                Id = corpoRespostaPost.Id.ToString();
            }

            //Atualizar Usu√°rio

            var atualizarUsuario = new Dictionary<string, string>
            {
                { "id", Id },
                { "nome", "Paulo Cesar Antunes" },
                { "usuario", "paulo_cesar@email.com.br" },
                { "senha", "12345678" },
                { "foto", "-" }
            };

            var corpoRequisicaoAtualizar = JsonConvert.SerializeObject(atualizarUsuario);

            var requisicaoPut = new HttpRequestMessage(HttpMethod.Put, "/usuarios/atualizar")
            {
                Content = new StringContent(
                corpoRequisicaoAtualizar,
                Encoding.UTF8,
                "application/json"
                )
            };

            _client.DefaultRequestHeaders.Add("Authorization", GerarFakeToken());
            var respostaPut = await _client.SendAsync(requisicaoPut);

            Assert.Equal(200, (int)respostaPut.StatusCode);

        }

        [Fact, Order(4)]
        public async Task DeveListarTodosOsUsuarios()
        {

            _client.DefaultRequestHeaders.Add("Authorization", GerarFakeToken());
            var respostaGet = await _client.GetAsync("/usuarios/all");

            Assert.Equal(200, (int)respostaGet.StatusCode);

        }

    }

}
```

<br />

<div align="left"><img src="https://i.imgur.com/p0zl5ZX.png" title="source: imgur.com" width="4%"/> <a href="https://textbooks.cs.ksu.edu/cis400/1-object-orientation/04-testing/05-xunit-assertions/" target="_blank"><b>Documenta√ß√£o: Classe Assert</b></a></div>

<br />

<h2>üë£ Passo 02 - Executando os Testes no Visual Studio</h2>



Chegou a hora de executar os testes:

1. No Menu **Teste**, clique na op√ß√£o **Executar Todos os Testes**.

<div align="center"><img src="https://i.imgur.com/bi5fDFe.png" title="source: imgur.com" /></div>

2. Ser√° aberta a Janela **Gerenciador de Testes**.
3. Aguarde a Execu√ß√£o dos Testes. Se o teste passou ser√° exibido um **check** na cor verde, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/EAwq8jr.png" title="source: imgur.com" /></div>

4. Se o teste falhou ser√° exibido um **X** na cor vermelha, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/WO3Mz8E.png" title="source: imgur.com" /></div>

5. Para Executar os testes novamente, voc√™ tem 2 op√ß√µes:

- No **Gerenciador de Testes**, clique no bot√£o **Executar Todos** <img src="https://i.imgur.com/nTWT0Vx.png" title="source: imgur.com" width="3%"/>, para executar todos os testes novamente.
- No **Gerenciador de Testes**, selecione o teste que voc√™ deseja executar e clique no bot√£o **Executar** <img src="https://i.imgur.com/SdZ9cYJ.png" title="source: imgur.com" width="3%"/>, para executar todos os testes novamente.

<br />

| <img src="https://i.imgur.com/L338M2G.png" title="source: imgur.com" width="100px"/> | **DESAFIO:** *Fa√ßa algumas altera√ß√µes nos dados dos Objetos e/ou escreva outros testes para praticar.** A melhor forma de aprender e compreender como funcionam os testes √© praticando! * |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="5%"/> <a href="" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br />

<h2>‚úî Boas pr√°ticas</h2>

<br />

1. **Fa√ßa testes pequenos.**
2. **Fa√ßa testes r√°pidos:** Os testes devem ser simples e objetivos porqu√™ ser√£o executados o tempo todo.
3. **Fa√ßa testes determin√≠sticos:** O teste deve garantir o resultado.
4. **Utilize nomes auto descritivos:** A ideia √© que voc√™ entenda o que o teste faz sem precisar abri-lo.
6. **Insira poucas asser√ß√µes em cada teste:** O objetivo √© que um teste seja respons√°vel por apenas uma verifica√ß√£o.
7. **Sempre avalie os resultados dos seus testes.**

<br /> <br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>