<h1>Projeto 02 - Blog Pessoal - Recurso User (Usu√°rio) - Parte 02</h1>



O que veremos por aqui:

1. Criar a Interface IUserService
2. Criar a Classe UserService
3. Atualizar a Classe PostagemService
4. Registrar a Classe UserService na Classe Program
5. Criar a Classe UserController
6. Testar todos os M√©todos no Insomnia
7. Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem

<br />

<h2>1. O Recurso User</h2>



Na etapa anterior, come√ßamos a construir o Recurso User e criamos o Relacionamento entre as Classes User e Postagem. Veja o Diagrama de Classes abaixo: 

```mermaid
classDiagram
class Tema {
  + Id : long
  + Descricao : string
  + Postagem : ICollection ~Postagem~
  + GetAll()
  + GetById(long id)
  + GetByDescricao(string descricao)
  + Create(Tema tema)
  + Update(Tema tema)
  + Delete(long id)
}
class Postagem {
  + Id : Long
  + Titulo : String
  + Texto: String
  + Tema : Tema
  + Usuario : Usuario
  + GetAll()
  + GetById(long id)
  + GetByTitulo(string titulo)
  + Create(Postagem postagem)
  + Update(Postagem postagem)
  + Delete(long id)
}
class Auditable {
  + Data: DateTimeOffset
}
class User {
  + Id : long
  + Nome : string
  + Usuario : string
  + Senha : string
  + Foto : string
  + postagem : ICollection ~Postagem~
  + GetAll()
  + GetById(long id)
  + Autenticar(UsuarioLogin usuarioLogin)
  + Create(Usuario usuario)
  + Update(Usuario usuario)
}
class UserLogin{
  + id : Long
  + nome : String
  + usuario : String
  + senha : String
  + foto : String
  + token : String
}
Postagem --|> Auditable: Herda
Tema <-- Postagem: Possui um
User <-- Postagem: Possui um
```

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o Recurso User. Todas as Classes constru√≠das no Recurso Postagem dever√£o ser constru√≠das no Recurso User com as adapta√ß√µes pertinentes ao Recurso User.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Classes UserService e UserController, executar o projeto, entre outras, consulte a Documenta√ß√£o do Recurso Postagem.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 01 - Criar a Interface IUserService</h2>



Vamos criar a **Interface IUserService** na pasta **Service**.

1. Clique com o bot√£o direito do mouse sobre a **pasta Service** e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Novo item**
2. Na janela **Adicionar Novo Item**, Selecione a op√ß√£o **Interface**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/9dkGfqs.png" title="source: imgur.com" /></div>

3. No item **Nome**, digite o nome da Interface (**IUserService**)

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a Interface Service. Na Linguagem C# toda a Interface inicia o nome com a Letra I (mai√∫scula), porque geralmente a Classe que implementa a Interface tem o mesmo nome da Interface.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Agora vamos criar o c√≥digo da **Interface IUserService**:

```c#
using blogpessoal.Model;

namespace blogpessoal.Service
{
    public interface IUserService
    {
        Task<IEnumerable<User>> GetAll();

        Task<User?> GetById(long id);

        Task<User?> GetByUsuario(string usuario);

        Task<User?> Create(User usuario);

        Task<User?> Update(User usuario);
    }
}
```

Observe que diferente dos Recursos **Postagem e Tema**, n√£o iremos construir o M√©todo **Delete(long id)**. O Objetivo √© impedir que um usu√°rio seja exclu√≠do por qualquer usu√°rio.

<br />

<h2>üë£ Passo 02 - Criar a Classe UserService</h2>



Vamos criar a **Classe UserService** na pasta **Implements**, dentro da pasta **Service**:

1. Clique com o bot√£o direito do mouse sobre a **pasta Implements**, localizada dentro da pasta **Service**, e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Classe**.
2. No item **Nome**, digite o nome da Classe (**UserService**)

Veja abaixo a implementa√ß√£o da Classe **UserService**:

```c#
using blogpessoal.Data;
using blogpessoal.Model;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal.Service.Implements
{
    public class UserService : IUserService
    {
        public readonly AppDbContext _context;

        public UserService(AppDbContext context)
        {
            _context = context;

        }

        public async Task<IEnumerable<User>> GetAll()
        {
            return await _context.Users
                .Include(u => u.Postagem)
                .ToListAsync();
        }

        public async Task<User?> GetById(long id)
        {
            try
            {
                var Usuario = await _context.Users
                    .Include(u => u.Postagem)
                    .FirstAsync(i => i.Id == id);

                Usuario.Senha = "";

                return Usuario;
            }
            catch
            {
                return null;
            }

        }

        public async Task<User?> GetByUsuario(string usuario)
        {
            try
            {
                var BuscaUsuario = await _context.Users
                    .Include(u => u.Postagem)
                    .Where(u => u.Usuario == usuario)
                    .FirstOrDefaultAsync();

                return BuscaUsuario;
            }
            catch
            {
                return null;
            }
        }

        public async Task<User?> Create(User usuario)
        {
            var BuscaUsuario = await GetByUsuario(usuario.Usuario);

            if (BuscaUsuario is not null)
                return null;

            if (usuario.Foto is null || usuario.Foto == "")
                usuario.Foto = "https://i.imgur.com/I8MfmC8.png";

            usuario.Senha = BCrypt.Net.BCrypt.HashPassword(usuario.Senha, workFactor: 10);

            _context.Users.Add(usuario);
            await _context.SaveChangesAsync();

            return usuario;
        }

        public async Task<User?> Update(User usuario)
        {

            var UsuarioUpdate = await _context.Users.FindAsync(usuario.Id);

            if (UsuarioUpdate is null)
                return null;

            if (usuario.Foto is null || usuario.Foto == "")
                usuario.Foto = "https://i.imgur.com/I8MfmC8.png";

            usuario.Senha = BCrypt.Net.BCrypt.HashPassword(usuario.Senha, workFactor: 10);

            _context.Entry(UsuarioUpdate).State = EntityState.Detached;
            _context.Entry(usuario).State = EntityState.Modified;
            await _context.SaveChangesAsync();

            return usuario;
        }
    }
}

```

Observe que nos M√©todos de consulta: **GetAll(), GetById( long id ) e GetByUsuario( string usuario )** foi acrescentada a linha abaixo:

```c#
.Include(u => u.Postagem)
```

O comando **Include** tem por objetivo exibir os Objetos da Classe Postagem que est√£o relacionados com os Objetos da Classe User, ou seja, ao executar os M√©todos **GetAll(), GetById( long id ) e GetByDescricao( string descricao )**, al√©m de **exibir os Objetos da Classe User persistidos no Banco de dados**, ser√° exibido tamb√©m **a lista de Objetos da Classe Postagem associados a cada Objeto da Classe da User**, semelhante ao exemplo abaixo:

```json
{
	"id": 1,
	"nome": "Administrador do Sistema",
	"usuario": "admin@email.com.br",
	"senha": "$2b$10$L/EWEnHwCGNahp9cYbdjYuoz1rsGXl9ukSHi9mILWQRwGYoyIDMdq",
	"foto": "https://i.imgur.com/Tk9f10K.png",
	"postagem": [
		{
			"id": 1,
			"titulo": "Postagem 01",
			"texto": "Texto da minha postagem 01",
			"data": "2023-06-08T23:28:57.2305447",
		},
		{
			"id": 3,
			"titulo": "Postagem 03",
			"texto": "Texto da minha postagem 03",
			"data": "2023-06-09T00:04:27.3084565",
		}
	]
}
```

Observe que logo ap√≥s os dados do usu√°rio, foi criado um array contendo as duas postagens associadas ao usu√°rio.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** *Se o comando Include n√£o for adicionada nos 3 M√©todos de consulta, ao testar os M√©todos GET no Insomnia o Relacionamento entre as Classes n√£o ser√° exibido.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Note que no M√©todo de consulta **GetById( long id )**, o atributo **senha** do Objeto usuario foi deixado em branco, antes do Objeto ser retornado. Este processo n√£o deixa a senha em branco no Banco de dados porque n√£o estamos fazendo uma persist√™ncia ou atualiza√ß√£o nos dados, **apenas exibir√° na consulta pelo id o atributo senha vazio**, o que simplifica o processo de criar uma p√°gina para alterar a senha do usu√°rio, por exemplo.

Quanto aos M√©todos **Create(User usuario)** e **Update(User usuario)**, vamos analisar as diferen√ßas de implementa√ß√£o em rela√ß√£o aos Recursos Postagem e Tema:

<br />

<h3>2.1. M√©todo Create - Usu√°rio</h3>



O Objeto usuario ser√° enviado pelo M√©todo da **Classe UsuarioController**, atrav√©s de um **JSON**, ser√° semelhante ao exemplo abaixo:

```json
{
    "nome": "Administrador",
    "usuario": "admin@email.com.br",
    "senha": "admin123",
    "foto": ""
}
```

Observe que todos os Atributos ser√£o enviados, **exceto o id**, porqu√™ ele **ser√° gerado pelo Banco de dados**. O atributo foto foi deixado em branco para testarmos se a foto padr√£o ser√° persistida no Banco de dados.

<div align="center"><img src="https://i.imgur.com/TCSYjQM.png" title="source: imgur.com" /></div>

**Linha 62:** Criamos um Objeto da Classe Usuario, chamado **BuscaUsuario**, para receber o resultado da execu√ß√£o do M√©todo **GetByUsuario(string usuario)**, da Classe **UsuarioService**. O objetivo √© checar se o Atributo usuario, do Objeto da Classe User, que ser√° persistido j√° existe.

**Linhas 64 e 65:** Verifica se o Objeto **BuscaUsuario n√£o √© nulo**, ou seja, se o Objeto da Classe User existe. Caso ele exista, ele n√£o poder√° ser persistido no Banco de dados, logo o M√©todo **Create(User usuario)** retornar√° nulo (null).

**Linhas 67 e 68:** Verifica se o atributo **Foto**, do Objeto usuario √© nulo ou vazio. Caso seja nulo ou vazio, inserimos uma imagem padr√£o. Como construiremos no Frontend uma p√°gina contendo perfil do Usu√°rio √© importante termos uma imagem para n√£o "quebrar" o visual da p√°gina.

**Linha 70:** Atrav√©s do **M√©todo HashPassword(string senha, workFactor: 10)**, do Pacote **Bcrypt**, vamos criptografar a senha do Objeto usuario antes de persistir o Objeto no Banco de dados. Observe que a  senha n√£o criptografada (digitada no login) ser√° substitu√≠da pela senha criptografada. O Par√¢metro **workFactor: 10** √© uma propriedade do Algoritmo BCrytpt, que indica quantos caracteres aleat√≥rios ser√£o inseridos dentro da string depois de criptografada. Neste caso, definimos 10 caracteres.

No caso de uma persist√™ncia dos dados bem sucedida, o retorno esperado do M√©todo **SaveChangesAsync()** ser√° a confirma√ß√£o do Objeto persistido, no formato JSON, como mostra o exemplo abaixo:

```json
{
    "id": 1,
	"nome": "Administrador",
	"usuario": "admin@email.com.br",
	"senha": "$2b$10$L/EWEnHwCGNahp9cYbdjYuoz1rsGXl9ukSHi9mILWQRwGYoyIDMdq",
	"foto": "https://i.imgur.com/I8MfmC8.png",
	"postagem": []
}
```

Observe que a senha est√° criptografada.

<br />

<h3>2.2. M√©todo Update - Usu√°rio</h3>



O Objeto usuario ser√° enviado pelo M√©todo da **Classe UsuarioController**, atrav√©s de um **JSON**, ser√° semelhante ao exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador do Sistema",
    "usuario": "admin@email.com.br",
    "senha": "admin123",
    "foto": "https://i.imgur.com/Tk9f10K.png"
}
```

Observe que todos os Atributos ser√£o enviados, **inclusive o id**, porqu√™ ele **ser√° utilizado para identificar o Objeto usuario que ser√° atualizado**. Atualizamos os atributo nome e foto.

<div align="center"><img src="https://i.imgur.com/hIoxtlc.png" title="source: imgur.com" /></div>

**Linhas 86 e 87:** Verifica se o atributo **Foto**, do Objeto usuario √© nulo ou vazio. Caso seja nulo ou vazio, inserimos uma imagem padr√£o. Como construiremos no Frontend uma p√°gina contendo perfil do Usu√°rio √© importante termos uma imagem para n√£o "quebrar" o visual da p√°gina.

**Linha 89:** Atrav√©s do **M√©todo HashPassword(string senha, workFactor: 10)**, do Pacote **Bcrypt**, vamos criptografar a senha do Objeto usuario antes de persistir o Objeto no Banco de dados. Observe que a  senha n√£o criptografada (digitada no login) ser√° substitu√≠da pela senha criptografada. O Par√¢metro **workFactor: 10** √© uma propriedade do Algoritmo BCrytpt, que indica quantos caracteres aleat√≥rios ser√£o inseridos dentro da string depois de criptografada. Neste caso, definimos 10 caracteres.

No caso de uma atualiza√ß√£o dos dados bem sucedida, o retorno esperado do M√©todo **SaveChangesAsync()** ser√° a confirma√ß√£o do Objeto persistido, no formato JSON, como mostra o exemplo abaixo:

```json
{
    "id": 1,
	"nome": "Administrador do Sistema",
	"usuario": "admin@email.com.br",
	"senha": "$2b$10$mXsoRRRUT1moBDzTZfhyKuKApUHFugyRDqAdQEPumnrwGrmXuzeNy",
	"foto": "https://i.imgur.com/Tk9f10K.png",
	"postagem": []
}
```

Observe que a senha est√° criptografada, por√©m n√£o √© mais a mesma sequencia de caracteres de quando foi criada, mesmo que a senha tenha sido mantida a mesma.

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/neoKushan/BCrypt.Net-Core" target="_blank"><b>Documenta√ß√£o: Pacote BCrypt</b></a></div>

<br />

<h2>üë£ Passo 03 - Atualizar a Classe PostagemService</h2>



Da mesma forma que adicionamos o comando **Include** na Classe UserService, tamb√©m iremos adicionar na Classe PostagemService, nos 3 M√©todos de consulta: **GetAll(), GetById( long id ) e GetByTitulo( string titulo )**. No trecho de c√≥digo abaixo, vemos com ficar√° o comando **Include** na Classe PostagemService:

```c#
.Include(p => p.Usuario)
```

Desta forma, ao executar os M√©todos de consulta:  **GetAll(), GetById( long id ) e GetByTitulo( string titulo )**, os Objetos da Classe Postagem passar√£o a exibir o Objeto da Classe User associado, semelhante ao exemplo abaixo:

```json
{
	"id": 1,
	"titulo": "Postagem 01",
	"texto": "Texto da minha postagem 01",
	"data": "2023-06-08T23:28:57.2305447",
	"temaId": 1
	"tema": {
		"id": 1,
		"descricao": "Tema 01"
	},
	"usuario" :{
        "id": 1,
        "nome": "Administrador do Sistema",
        "usuario": "admin@email.com.br",
        "senha": "$2b$10$mXsoRRRUT1moBDzTZfhyKuKApUHFugyRDqAdQEPumnrwGrmXuzeNy",
        "foto": "https://i.imgur.com/Tk9f10K.png"
    }
}
```

Observe que nos M√©todos **Create(Postagem postagem) e Update(Postagem postagem)** foi acrescentada a linha abaixo:

```c#
postagem.Usuario = postagem.Usuario is not null ? _context.Users.FirstOrDefault(t => t.Id == postagem.Usuario.Id) : null;
```

Da mesma forma que fizemos com o Recurso Tema, esta linha verifica antes de Criar ou Atualizar um Objeto Postagem se o Objeto da Classe User foi associado. Caso tenha sido, o Objeto User √© localizado e associado ao Objeto Postagem. Caso n√£o tenha sido associado, o Objeto User √© mantido como nulo (null). Sem esta linha, n√£o ser√° poss√≠vel associar um User a Postagem.

Veja abaixo a implementa√ß√£o atualizada da Classe **PostagemService**:

```c#
using blogpessoal.Data;
using blogpessoal.Model;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal.Service.Implements
{
    public class PostagemService : IPostagemService
    {

        private readonly AppDbContext _context;

        public PostagemService(AppDbContext context)
        {
            _context = context;
        }

        public async Task<IEnumerable<Postagem>> GetAll()
        {
            return await _context.Postagens
                .Include(p => p.Tema)
                .Include(p => p.Usuario)
                .ToListAsync();
        }

        public async Task<Postagem?> GetById(long id)
        {
            try
            {
                var Postagem = await _context.Postagens
                    .Include(p => p.Tema)
                    .Include(p => p.Usuario)
                    .FirstAsync(i => i.Id == id);

                return Postagem;
            }
            catch
            {
                return null;
            }

        }

        public async Task<IEnumerable<Postagem>> GetByTitulo(string titulo)
        {
            var Postagem = await _context.Postagens
                .Include(p => p.Tema)
                .Include(p => p.Usuario)
                .Where(p => p.Titulo.Contains(titulo))
                .ToListAsync();

            return Postagem;
        }

        public async Task<Postagem?> Create(Postagem postagem)
        {

            if (postagem.Tema is not null)
            {
                var BuscaTema = await _context.Temas.FindAsync(postagem.Tema.Id);

                if (BuscaTema is null)
                    return null;
            }

            postagem.Tema = postagem.Tema is not null ? _context.Temas.FirstOrDefault(t => t.Id == postagem.Tema.Id) : null;
            postagem.Usuario = postagem.Usuario is not null ? _context.Users.FirstOrDefault(u => u.Id == postagem.Usuario.Id) : null;
            
            await _context.Postagens.AddAsync(postagem);
            await _context.SaveChangesAsync();

            return postagem;

        }

        public async Task<Postagem?> Update(Postagem postagem)
        {

            var PostagemUpdate = await _context.Postagens.FindAsync(postagem.Id);

            if (PostagemUpdate is null)
                return null;

            if (postagem.Tema is not null)
            {
                var BuscaTema = await _context.Temas.FindAsync(postagem.Tema.Id);

                if (BuscaTema is null)
                    return null;
            }

            postagem.Tema = postagem.Tema is not null ? _context.Temas.FirstOrDefault(t => t.Id == postagem.Tema.Id) : null;
            postagem.Usuario = postagem.Usuario is not null ? _context.Users.FirstOrDefault(u => u.Id == postagem.Usuario.Id) : null;

            _context.Entry(PostagemUpdate).State = EntityState.Detached;
            _context.Entry(postagem).State = EntityState.Modified;
            await _context.SaveChangesAsync();

            return postagem;

        }

        public async Task Delete(Postagem postagem)
        {

            _context.Postagens.Remove(postagem);
            await _context.SaveChangesAsync();

        }

    }
}
```

<br />

<h2>üë£ Passo 04 - Registrar a Classe UserService na Classe Program</h2>



Vamos registrar a Classe **UserService** como um servi√ßo na Classe **Program**. 

1. Abra a Classe **Program**;
2. Localize a linha indicada abaixo:

 <div align="left"><img src="https://i.imgur.com/md27wY4.png" title="source: imgur.com" /></div>

4. Ap√≥s a linha indicada acima, adicione o trecho de c√≥digo abaixo:

```c#
 builder.Services.AddScoped<IUserService, UserService>();
```

5. A imagem abaixo, mostra como ficar√° o trecho com a nova linha:

 <div align="left"><img src="https://i.imgur.com/0xqqGin.png" title="source: imgur.com" /></div>

Veja o c√≥digo completo da Classe **Program** abaixo:

```c#

using blogpessoal.Data;
using blogpessoal.Model;
using blogpessoal.Service.Implements;
using blogpessoal.Service;
using blogpessoal.Validator;
using FluentValidation;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // Add services to the container.

            // Add Controller Class
            builder.Services.AddControllers()
                .AddNewtonsoftJson(options =>
                {
                    options.SerializerSettings.ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;
                }
            );

            // Conex√£o com o Banco de dados
            var connectionString = builder.Configuration.
                    GetConnectionString("DefaultConnection");

            builder.Services.AddDbContext<AppDbContext>(options =>
                options.UseSqlServer(connectionString)
            );

            // Valida√ß√£o das Entidades
            builder.Services.AddTransient<IValidator<Postagem>, PostagemValidator>();
            builder.Services.AddTransient<IValidator<Tema>, TemaValidator>();
            builder.Services.AddTransient<IValidator<User>, UserValidator>();

            // Registrar as Classes e Interfaces Service
            builder.Services.AddScoped<IPostagemService, PostagemService>();
            builder.Services.AddScoped<ITemaService, TemaService>();
            builder.Services.AddScoped<IUserService, UserService>();

            // Learn more about configuring Swagger/OpenAPI
            // at https://aka.ms/aspnetcore/swashbuckle

            builder.Services.AddEndpointsApiExplorer();
            builder.Services.AddSwaggerGen();

            // Configura√ß√£o do CORS
            builder.Services.AddCors(options => {
                options.AddPolicy(name: "MyPolicy",
                    policy =>
                    {
                        policy.AllowAnyOrigin()
                        .AllowAnyHeader()
                        .AllowAnyMethod();
                    });
            });

            var app = builder.Build();

            // Criar o Banco de dados e as tabelas Automaticamente
            using (var scope = app.Services.CreateAsyncScope())
            {
                var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                dbContext.Database.EnsureCreated();

            }

            app.UseDeveloperExceptionPage();

            // Configure the HTTP request pipeline.
            if (app.Environment.IsDevelopment())
            {
                app.UseSwagger();
                app.UseSwaggerUI();
            }

            app.UseCors("MyPolicy");

            app.UseAuthorization();

            app.MapControllers();

            app.Run();
        }
    }
}
```

<br />

<h2>üë£ Passo 05 - Criar a Classe UserController</h2>



Vamos criar a **Classe PostagemController** na pasta **Controller**:

1. Clique com o bot√£o direito do mouse sobre a **pasta Controller** e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Classe**.
2. No item **Nome**, digite o nome da Classe (**UserController**)

Veja abaixo a implementa√ß√£o da Classe **UserController**:

```c#
using blogpessoal.Model;
using blogpessoal.Service;
using FluentValidation;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace blogpessoal.Controllers
{

    [Route("~/usuarios")]
    [ApiController]
    public class UserController : ControllerBase
    {

        private readonly IUserService _userService;
        private readonly IValidator<User> _userValidator;

        public UserController(
            IUserService userService,
            IValidator<User> userValidator
            )
        {
            _userService = userService;
            _userValidator = userValidator;

        }

        [HttpGet("all")]
        public async Task<ActionResult> GetAll()
        {
            return Ok(await _userService.GetAll());
        }

        [HttpGet("{id}")]
        public async Task<ActionResult> GetById(long id)
        {
            var Resposta = await _userService.GetById(id);

            if (Resposta is null)
            {
                return NotFound("Usu√°rio n√£o encontrado!");
            }

            return Ok(Resposta);
        }

        [HttpPost("cadastrar")]
        public async Task<ActionResult> Create([FromBody] User usuario)
        {
            var validarUser = await _userValidator.ValidateAsync(usuario);

            if (!validarUser.IsValid)
                return StatusCode(StatusCodes.Status400BadRequest, validarUser);

            var Resposta = await _userService.Create(usuario);

            if (Resposta is null)
                return BadRequest("Usu√°rio j√° cadastrado!");

            return CreatedAtAction(nameof(GetById), new { id = Resposta.Id }, Resposta);
        }

        [HttpPut("atualizar")]
        public async Task<ActionResult> Update([FromBody] User usuario)
        {
            if (usuario.Id == 0)
                return BadRequest("O Id do Usu√°rio √© inv√°lido!");
            
            var validarUser = await _userValidator.ValidateAsync(usuario);

            if (!validarUser.IsValid)
                return StatusCode(StatusCodes.Status400BadRequest, validarUser);

            var UserUpdate = await _userService.GetByUsuario(usuario.Usuario);

            if ((UserUpdate is not null) && (UserUpdate.Id != usuario.Id))
                return BadRequest("O Usu√°rio (e-mail) j√° est√° em uso por outro usu√°rio.");

            var Resposta = await _userService.Update(usuario);

            if (Resposta is null)
                return BadRequest("Usu√°rio n√£o encontrado!");

            return Ok(Resposta);
        }

    }
}
```

Observe que a implementa√ß√£o √© semelhante as Classes **PostagemController** e **TemaController**. 

Note que o M√©todo **Create(User usuario)** diferente do Recurso **Postagem**, o M√©todo retornar√° o HTTP Status **BAD REQUEST ü°™ 400** para indicar que o usu√°rio j√° existe.

Observe apenas que o M√©todo **Update(User usuario)** foram criadas algumas checagens adicionais:

<div align="center"><img src="https://i.imgur.com/YfJqEkZ.png" title="source: imgur.com" /></div>

**Linha 74:** Criamos um Objeto da Classe Usuario, chamado **UserUpdate**, para receber o resultado da execu√ß√£o do M√©todo **GetByUsuario(string usuario)**, da Classe **UsuarioService**. O objetivo √© checar se o Atributo usuario, do Objeto da Classe User, que ser√° persistido j√° existe.

**Linha 76:** Verifica se o Objeto **UserUpdate n√£o √© nulo** e se o **Atributo id do Objeto UserUpdate (Objeto encontrado no Banco de dados)** √© diferente do **Atributo id do Objeto usuario (Objeto enviado na Requisi√ß√£o)**.

A primeira condi√ß√£o do if, verifica se o usu√°rio digitou no Atributo usuario, um e-mail que j√° foi persistido no Banco de dados.  Caso este e-mail exista, o Objeto **UserUpdate n√£o ser√° nulo**.

Observe que **n√£o basta apenas checar a exist√™ncia do e-mail para permitir a atualiza√ß√£o**, precisamos **verificar tamb√©m se o e-mail pertence ao usu√°rio que ser√° atualizado**, caso contr√°rio teremos uma **duplica√ß√£o de usu√°rio (e-mail)**.

A segunda condi√ß√£o do if, verifica se **o Atributo id enviado no corpo da requisi√ß√£o √© diferente do Atributo id, que foi encontrado no Banco de dados**. Caso seja diferente, significa que o e-mail existe, mas **n√£o pertence ao Objeto que ser√° atualizado**, logo a atualiza√ß√£o n√£o pode ser efetuada.

**Linha 77:** Se as 2 condi√ß√µes da linha 76  forem satisfeitas, ou seja, o usu√°rio foi encontrado e pertence a outro  usu√°rio, ser√° retornado o HTTP Status **BAD REQUEST ü°™ 400** (Usu√°rio j√° Existe!).

<br />

<h2>üë£ Passo 06 - Executar o projeto</h2>



Para executarmos o Projeto, clique no bot√£o <img src="https://i.imgur.com/gPnfOVk.png" title="source: imgur.com" width="8%"/>**Run http**, na **Barra de Ferramentas Principal** (indicado em verde na imagem):

![Imagem 30](https://i.imgur.com/Ya4O50P.png)

<br />

<h2>üë£ Passo 07 - Testar o Recurso User no Insomnia</h2>



Vamos criar no Insomnia todas as requisi√ß√µes necess√°rias para testar os 5 M√©todos do Recurso Usuario. Veja abaixo como ficam as requisi√ß√µes para testar o Recurso Usuario:

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Requisi√ß√µes, consulte a Documenta√ß√£o dos Recursos Postagem e Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="120px"/> | <div align="left"> **ATEN√á√ÉO:** *Depois de criar o Relacionamento entre Classes, todas as Consultas dos Recursos Postagem, Tema e Usuario trar√£o os Objetos associados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h3>4.1. Criando a Pasta Usuario</h3>

Vamos criar dentro da **Collection Blog Pessoal** a **Pasta Usuario**, que guardar√° todas as requisi√ß√µes do **Recurso Usuario**.

1. Na **Collection Blog Pessoal**, clique no bot√£o <img src="https://i.imgur.com/3Ou2SAZ.png" title="source: imgur.com" width="6%"/>. No menu que ser√° aberto, clique na op√ß√£o **New Folder**.

<div align="center"><img src="https://i.imgur.com/gIGZFHc.png" title="source: imgur.com" /></div>

2. Na janela que ser√° aberta, informe o nome da pasta (**Usuario**) e clique no bot√£o **Create** para concluir. 

<div align="center"><img src="https://i.imgur.com/etf4wwv.png" title="source: imgur.com" width="90%"/></div>

<br />

<h3>4.2. Criar a  Requisi√ß√£o - Cadastrar Usuario</h3>

Vamos come√ßar pela requisi√ß√£o Cadastrar Usuario porqu√™ sem um usu√°rio cadastrado n√£o ser√° poss√≠vel autenticar (logar) no sistema e acessar os demais endpoints.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New HTTP Request**.

<div align="center"><img src="https://i.imgur.com/gEzaJVM.png" title="source: imgur.com" /></div>

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.
3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/BIsfvDG.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/StSstJW.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo Post o Corpo da requisi√ß√£o (Request Body), deve ser preenchido com um JSON contendo o nome, o usuario (e-mail), a senha e a foto(link), que vc deseja persistir no Banco de dados.

9. Observe que depois de persistir os dados do usuario, a aplica√ß√£o retornar√° a senha criptografada.

<div align="center"><img src="https://i.imgur.com/GPIA7LX.png" title="source: imgur.com" /></div>

<br />

<h3>4.3. Criar a  Requisi√ß√£o - Consultar todos os Usuarios</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/Veedyux.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/VS6GHtB.png" title="source: imgur.com" /></div>

<br />

<h3>4.4. Criar a  Requisi√ß√£o - Consultar Usuario por Id</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/RLUrAOZ.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/izw4ogI.png" title="source: imgur.com" /></div>

<br />

<h3>4.5. Criar a  Requisi√ß√£o - Atualizar Usu√°rio</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Requisi√ß√£o**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/dE5zZge.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure o endere√ßo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/1s5fFI0.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo **PUT** o Corpo da requisi√ß√£o (Request Body), deve ser preenchido com um JSON contendo o Id, o nome, o usuario (e-mail), a senha e a foto(link) que vc deseja atualizar no Banco de dados.

<br />

<h2>üë£ Passo 08 - Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem no Insomnia</h2>



Como habilitamos o Relacionamento entre as Classes, para Cadastrarmos e Alterarmos as Postagens vamos precisar atender alguns requisitos:

- Os Objetos da Classe User devem ser persistidos antes de criarmos as Postagens.
- Nas requisi√ß√µes Cadastrar e Atualizar Postagem, o JSON enviado no Corpo da Requisi√ß√£o deve conter um Objeto da Classe User identificado apenas pelo **Atributo id**.

<br />

<h3>8.1. Atualizar - Requisi√ß√£o Cadastrar Postagem</h3>



Vamos alterar o Corpo da requisi√ß√£o (Body), da Requisi√ß√£o Cadastrar Postagem, do Recurso Postagem.	

1. No Insomnia, abra a pasta Postagem e clique sobre a requisi√ß√£o Cadastrar Postagem.

2. Altere o corpo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/TzS8Zej.png" title="source: imgur.com" /></div>

No item marcado em amarelo na imagem acima, observe que est√° sendo passado dentro do JSON um **Objeto da Classe User** chamado **usuario**, identificado apenas pelo **Atributo id**.

A Resposta da Requisi√ß√£o ser√° semelhante a figura abaixo:

<div align="center"><img src="https://i.imgur.com/Ja00A98.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Cadastrar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>8.2. Atualizar - Requisi√ß√£o Atualizar Postagem</h3>



Vamos alterar o Corpo da requisi√ß√£o (Body), da Requisi√ß√£o Atualizar Postagem, do Recurso Postagem.	

1. No Insomnia, abra a pasta Postagem e clique sobre a requisi√ß√£o Atualizar Postagem.

2. Altere o corpo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/eCdecLM.png" title="source: imgur.com" /></div>

No item marcado em amarelo na imagem acima, observe que est√° sendo passado dentro do JSON um **Objeto da Classe User** chamado **usuario**, identificado apenas pelo **Atributo id**.

A Resposta da Requisi√ß√£o ser√° semelhante a figura abaixo:

<div align="center"><img src="https://i.imgur.com/nYg7kQp.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Atualizar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

Observe que n√£o fizemos a **checagem do Usu√°rio na Classe PostagemService**, assim como fizemos com o tema, porque o usu√°rio ser√° utilizado para autenticar no sistema, logo essa informa√ß√£o ficar√° armazenada no Frontend at√© o usu√°rio efetuar logout ou token expirar. Logo a passagem deste par√¢metro ser√° autom√°tica, ou seja, como ser√° necess√°rio autenticar o usu√°rio antes de publicar uma postagem, ao persistir a nova postagem o Frontend se encarregar√° de inserir o usu√°rio autenticado nas Requisi√ß√µes Criar e Atualizar postagem.

No pr√≥ximo conte√∫do, vamos criar o ultimo M√©todo do Recurso User, o M√©todo Autenticar (Logar)...

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="5%"/> <a href="" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
