<h1>Projeto 02 - Blog Pessoal - Relacionamento entre Classes - Recurso Tema - Parte 01</h1>



O que veremos por aqui:

1. Apresenta√ß√£o do Recurso Tema
2. Criar a Classe Model Tema
4. Criar a Classe TemaValidator
5. Registrar a Classe Validator PostagemValidator na Classe Program
6. Registrar a Classe Model Postagem na Classe AppDbContext
7. Criar o Relacionamento entre as Classes Postagem e Tema na Classe AppDbContext

<br />

<h2>1. O Recurso Tema</h2>



Nesta etapa vamos come√ßar a construir o Recurso Tema. Veja o Diagrama de Classes abaixo: 

```mermaid
classDiagram
class Tema {
  - Id : long
  - Descricao : string
  + GetAll()
  + GetById(long id)
  + GetByDescricao(string descricao)
  + Create(Tema tema)
  + Update(Tema tema)
  + Delete(long id)
}
```

A **Classe Tema** servir√° de modelo para construir a tabela **tb_temas** (Model) dentro do nosso Banco de dados **db_blogpessoal**. Os campos (Atributos) da tabela ser√£o os mesmos que est√£o definidos no Diagrama de Classes acima. **Al√©m de construirmos a Classe Tema, tamb√©m faremos o Relacionamento com a Classe Postagem**, constru√≠da anteriormente. 

Na pr√≥xima etapa vamos construir as Classes **TemaService e TemaController**, que ir√° nos auxiliar na intera√ß√£o com o Banco de dados e onde ser√£o implementados os 6 m√©todos descritos no Diagrama de Classes acima.

Depois de criar a Classe Model Tema, vamos executar o projeto Blog Pessoal. Ap√≥s a execu√ß√£o veremos que ser√° criado no Banco de dados **db_blogpessoal** a tabela **tb_temas**. Veja abaixo como ficar√° a estrutura da nossa tabela atrav√©s do **Diagrama de Model e Relacionamentos (DER)**:

```mermaid
erDiagram
    Tema {
        BIGINT Id PK
        VARCHAR(255) Descricao
    }
```

O Dicion√°rio de dados da nossa tabela tb_temas ser√° o seguinte:

| Atributo      | Tipo de dado | Descri√ß√£o           | Chave |
| ------------- | ------------ | ------------------- | ----- |
| **Id**        | BIGINT       | Identificador √∫nico | PK    |
| **Descricao** | VARCHAR(255) | Tema                |       |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o Recurso Tema. Todas as Classes constru√≠das no Recurso Postagem dever√£o ser constru√≠das no Recurso Tema com as adapta√ß√µes pertinentes ao Recurso Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="80px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar o Recurso, executar o projeto, entre outras, consulte a Documenta√ß√£o do Recurso Postagem.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 01 - Criar a Classe Model Tema</h2>



Vamos criar a Classe Model **Tema**:

1. Clique com o bot√£o direito do mouse sobre a **pasta Model** e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Classe**
2. Na janela **Adicionar Novo item**, no item **Nome**, digite o nome da Classe (**Tema**) e clique no bot√£o **Adicionar** para concluir.

Agora vamos criar o c√≥digo da Classe **Tema**:

```c#
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace blogpessoal.Model
{
    public class Tema
    {

        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public long Id { get; set; }

        [Column(TypeName = "varchar")]
        [StringLength(255)]
        public string Descricao { get; set; } = string.Empty;

    }
}
```

Veja na tabela abaixo a convers√£o de **Tipo de dados C# ü°™ SQL, de acordo com o que foi definido no Diagrama de Classes acima:**

| Atributo      | Tipo de dado C# | Tipo de dado SQL |
| ------------- | --------------- | ---------------- |
| **Id**        | long            | BIGINT           |
| **Descricao** | <i>string</i>   | VARCHAR          |

<br />

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left">**DICA:** *Para relembrar os tipos de dados do C#, <a href="https://github.com/rafaelq80/cookbook_csharp/blob/main/01_csharp/03.md">clique aqui</a> e explore os principais tipos de dados oferecidos pelo C#.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Observe que o c√≥digo √© semelhante ao da Classe Model **Postagem**, do Recurso Postagem.

<br />

<h2>üë£ Passo 02 - Criar a Classe Validator TemaValidator</h2>



Vamos criar a Classe de Valida√ß√£o de dados **TemaValidator**:

1. Clique com o bot√£o direito do mouse sobre a **pasta Validator** e na sequ√™ncia, clique na op√ß√£o **Adicionar ü°™ Classe**
2. Na janela **Adicionar Novo item**, no item **Nome**, digite o nome da Classe (**TemaValidator**) e clique no bot√£o **Adicionar** para concluir.

Agora vamos criar o c√≥digo da Classe **TemaValidator**:

```c#
using blogpessoal.Model;
using FluentValidation;

namespace blogpessoal.Validator
{
    public class TemaValidator : AbstractValidator<Tema>
    {
        
        public TemaValidator()
        {
            RuleFor(t => t.Descricao)
                .NotEmpty();
        }

    }
}
```

<br />

**Regras de Valida√ß√£o utilizadas**

| Propriedade    | Descri√ß√£o                           |
| -------------- | ----------------------------------- |
| **NotEmpty()** | A string n√£o pode ser nula ou vazia |

<br />

Observe que o c√≥digo √© semelhante ao da Classe de Valida√ß√£o de dados **PostagemValidator**, do Recurso Postagem.

<br />

<h2>üë£ Passo 03 - Registrar a Classe TemaValidator na Classe Program</h2>



Vamos registrar a Classe **TemaValidator** como um servi√ßo na Classe **Program**. 

1. Abra a Classe **Program**;
2. Localize a linha indicada abaixo:

 <div align="left"><img src="https://i.imgur.com/8EbYtfx.png" title="source: imgur.com" /></div>

4. Ap√≥s a linha indicada acima, adicione o trecho de c√≥digo abaixo:

```c#
builder.Services.AddTransient<IValidator<Tema>, TemaValidator>();
```

5. A imagem abaixo, mostra como ficar√° o trecho com a nova linha:

 <div align="left"><img src="https://i.imgur.com/oKR6mEr.png" title="source: imgur.com" /></div>

Veja o c√≥digo completo da Classe **Program** abaixo:

```c#

using blogpessoal.Data;
using blogpessoal.Model;
using blogpessoal.Service.Implements;
using blogpessoal.Service;
using blogpessoal.Validator;
using FluentValidation;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // Add services to the container.

            builder.Services.AddControllers();

            // Conex√£o com o Banco de dados
            var connectionString = builder.Configuration.
                    GetConnectionString("DefaultConnection");

            builder.Services.AddDbContext<AppDbContext>(options =>
                options.UseSqlServer(connectionString)
            );

            // Valida√ß√£o das Entidades
            builder.Services.AddTransient<IValidator<Postagem>, PostagemValidator>();
            builder.Services.AddTransient<IValidator<Tema>, TemaValidator>();

            // Registrar as Classes e Interfaces Service
            builder.Services.AddScoped<IPostagemService, PostagemService>();

            // Learn more about configuring Swagger/OpenAPI
            // at https://aka.ms/aspnetcore/swashbuckle

            builder.Services.AddEndpointsApiExplorer();
            builder.Services.AddSwaggerGen();

            // Configura√ß√£o do CORS
            builder.Services.AddCors(options => {
                options.AddPolicy(name: "MyPolicy",
                    policy =>
                    {
                        policy.AllowAnyOrigin()
                        .AllowAnyHeader()
                        .AllowAnyMethod();
                    });
            });

            var app = builder.Build();

            // Criar o Banco de dados e as tabelas Automaticamente
            using (var scope = app.Services.CreateAsyncScope())
            {
                var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                dbContext.Database.EnsureCreated();

            }

            app.UseDeveloperExceptionPage();

            // Configure the HTTP request pipeline.
            if (app.Environment.IsDevelopment())
            {
                app.UseSwagger();
                app.UseSwaggerUI();
            }

            app.UseCors("MyPolicy");

            app.UseAuthorization();

            app.MapControllers();

            app.Run();
        }
    }
}
```

<br />

<h2>üë£ Passo 04 - Registrar a Classe Tema na Classe AppDbContext</h2>



Vamos registrar a Classe **Tema** na Classe **AppDbContext**, para gerar a tabela **tb_temas** no Banco de dados.:

1. Abra a Classe **AppDbContext**, localizada na pasta **Data**;
2. Localize o M√©todo **OnModelCreating(ModelBuilder modelBuilder)**, indicado na imagem abaixo:

<div align="left"><img src="https://i.imgur.com/7P359XU.png" title="source: imgur.com" /></div>

4. Adicione a linha de c√≥digo abaixo dentro do M√©todo **OnModelCreating(ModelBuilder modelBuilder)**:

```c#
modelBuilder.Entity<Tema>().ToTable("tb_temas");
```

5. A imagem abaixo, mostra como ficar√° o M√©todo com a nova linha:

 <div align="left"><img src="https://i.imgur.com/K0w5MJB.png" title="source: imgur.com" /></div>

6. Localize a linha indicada abaixo:

<div align="left"><img src="https://i.imgur.com/72zPKSV.png" title="source: imgur.com" /></div>

7. Ap√≥s a linha indicada acima, adicione a linha de c√≥digo abaixo:

```c#
public DbSet<Tema> Temas { get; set; } = null!;
```

8. A imagem abaixo, mostra como ficar√° o trecho com a nova linha:

 <div align="left"><img src="https://i.imgur.com/ROCIa1H.png" title="source: imgur.com" /></div>

Veja o c√≥digo completo da Classe **AppDbContext** abaixo:

```c#
using blogpessoal.Model;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal.Data
{
    public class AppDbContext: DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options)
        {

        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.Entity<Postagem>().ToTable("tb_postagens");
            modelBuilder.Entity<Tema>().ToTable("tb_temas");
        }

        // Registro das Entidades
        public DbSet<Postagem> Postagens { get; set; } = null!;
        public DbSet<Tema> Temas { get; set; } = null!;

        public override Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
        {
            var insertedEntries = this.ChangeTracker.Entries()
                                   .Where(x => x.State == EntityState.Added)
                                   .Select(x => x.Entity);

            foreach (var insertedEntry in insertedEntries)
            {
                //Se uma propriedade da Classe Auditable estiver sendo criada. 
                if (insertedEntry is Auditable auditableEntity)
                {
                    auditableEntity.Data = DateTimeOffset.Now;
                }
            }

            var modifiedEntries = ChangeTracker.Entries()
                       .Where(x => x.State == EntityState.Modified)
                       .Select(x => x.Entity);

            foreach (var modifiedEntry in modifiedEntries)
            {
                //Se uma propriedade da Classe Auditable estiver sendo atualizada.  
                if (modifiedEntry is Auditable auditableEntity)
                {
                    auditableEntity.Data = DateTimeOffset.Now;
                }
            }

            return base.SaveChangesAsync(cancellationToken);
        }

    }
}
```

<br />

<h2>2. Relacionamento entre Classes</h2>



**Mapeamento Objeto-Relacional (ORM)** √© o processo de convers√£o das Classes em Tabelas (Models) no Banco de dados da aplica√ß√£o e vice-versa. Em outras palavras, isso nos permite interagir com um Banco de dados Relacional sem utilizar c√≥digo SQL. O **Entity Framework** √© um framework que define como persistir dados em aplicativos C#. O foco principal do Entity Framework √© a camada ORM. Para mais detalhes, consulte o conte√∫do <a href="03.md" target="_blank"><b>Introdu√ß√£o ao Entity Framework</b></a>.

O **Entity Framework** simplifica o tratamento do modelo de Banco de dados Relacional nos aplicativos ASP.NET quando mapeamos cada Tabela para uma √∫nica ou para um conjunto de Classes Model. Assim como no SQL, precisamos criar o Relacionamento entre duas tabelas, no Entity Framework tamb√©m precisamos criar o **Relacionamento entre as Classes** e desta forma ele construir√° os Relacionamento entre as duas Tabelas no Banco de dados assim como fizemos no SQL. 

Nesta etapa vamos construir o Relacionamento do Recurso Tema com o Recurso Postagem, a partir das Classes Model Tema e Postagem. Veja o Diagrama de Classes abaixo: 

```mermaid
classDiagram
class Tema {
  - Id : long
  - Descricao : string
  - Postagem : ICollection ~Postagem~
  + GetAll()
  + GetById(long id)
  + GetByDescricao(string descricao)
  + Create(Tema tema)
  + Update(Tema tema)
  + Delete(long id)
}
class Postagem {
  - Id : Long
  - Titulo : String
  - Texto: String
  - Tema : Tema
  - Usuario : Usuario
  + GetAll()
  + GetById(long id)
  + GetByTitulo(string titulo)
  + Create(Postagem postagem)
  + Update(Postagem postagem)
  + Delete(long id)
}
class Auditable {
  - Data: DateTimeOffset
}
Postagem --|> Auditable: Herda
Tema --> Postagem: Classifica
```

Para construirmos o Relacionamento entre Classes, o Entity Framework utiliza o **Fluent API**. O **Fluent API** √© uma API interna do Entity Framework, que √© utilizada para configurar as Classes de dom√≠nio para substituir as conven√ß√µes do Banco de dados. A Fluent API √© baseada em um padr√£o de design conhecido como Fluent Interface, onde o resultado √© formulado por encadeamento de m√©todos, semelhante ao que fizemos no Fluent Validator.

No Entity Framework Core, a classe **ModelBuilder** atua como uma API Fluent. O **Fluent API** permite configurar os seguintes aspectos de um modelo:

- **Configura√ß√£o do modelo:** Configura um modelo Entity Framework para mapeamentos de Banco de dados. Configura o esquema padr√£o, fun√ß√µes de Banco de dados, atributos de anota√ß√£o de dados adicionais e entidades a serem exclu√≠das do mapeamento.
- **Entity Configuration:** Configura a entidade para tabela e o mapeamento de relacionamentos, como por exemplo, a Chave Prim√°ria, Nome da tabela (inclusive configuramos este item na Classe **AppDbContext**), Relacionamentos um-para-um, um-para-muitos, muitos-para-muitos, entre outros.
- **Configura√ß√£o da propriedade:** Configura a propriedade para o mapeamento da coluna, como por exemplo, nome da coluna, valor padr√£o, nulidade, chave estrangeira, tipo de dados, entre outros.

Para criarmos um Relacionamento entre Classes precisamos definir quais Entidades ir√£o se Relacionar, a Dire√ß√£o do Relacionamento e a Cardinalidade do Relacionamento. 

<br />

<h3>2.1. Dire√ß√£o do Relacionamento</h3>



Quanto ao sentido, podemos definir de uma forma global dois tipos de Relacionamentos:

- **Unidirecional.**
- **Bidirecional.**

Nos **Relacionamentos Unidirecionais**, mapeamos somente uma das entidades  envolvidas no relacionamento. Nestes relacionamentos, temos os conceitos de **Entidade Fonte** e **Entidade Alvo**. A diferen√ßa b√°sica √© que a **Entidade Fonte** possui o Mapeamento do Relacionamento.

Nos **Relacionamentos Bidirecionais**, as  duas entidades s√£o mapeadas e o relacionamento acontece em ambos os  sentidos entre as entidades, que se comportam como se existissem dois  Relacionamentos Unidirecionais, um para cada entidade envolvida.

Nos Relacionamentos Bidirecionais temos o conceito de **Entidade Propriet√°ria** e **Entidade Inversa**.

- **Entidade Propriet√°ria:** A tabela dessa Entidade ser√° a Propriet√°ria da **Chave Estrangeira - Foreign Key**.
- **Entidade Inversa:** A entidade M√£e da rela√ß√£o

<br />

<h3>2.2. Cardinalidade de um Relacionamento</h3>



Para definir o Relacionamento e a Cardinalidade, o Entity Framework utiliza os M√©todos da Fluent API abaixo:

| M√©todo              | Descri√ß√£o                                                    |
| ------------------- | ------------------------------------------------------------ |
| **HasMany()**       | Configura o lado *Muitos* de uma rela√ß√£o muitos-para-muitos. |
| **HasOne()**        | Configura o lado *Um* de uma rela√ß√£o um-para-um ou um-para-muitos. |
| **WithMany()**      | Configura o lado *Muitos* de uma rela√ß√£o um-para-muitos ou um-para-muitos. O m√©todo **WithMany()** deve ser usado em conjunto com o M√©todo **HasOne()**. |
| **WithOne()**       | Configura o lado *Um* de uma rela√ß√£o um-para-um. O m√©todo **WithOne()** deve ser usado em conjunto com o M√©todo **HasOne()**. |
| **HasForeignKey()** | Define a Chave Estrangeira, ou seja, o atributo que ser√° criado na tabela para definir o Relacionamento. |
| **OnDelete()**      | Especifica a a√ß√£o que deve ocorrer em uma entidade dependente em um relacionamento quando o Objeto principal √© exclu√≠do. **Exemplo:** Ao excluir um Tema, todas as postagens associadas a este tema tamb√©m ser√£o exclu√≠das. Neste caso passamos como par√¢metro para o M√©todo **DeleteBehavior.Cascade** |

As combina√ß√µes de Relacionamentos poss√≠veis s√£o as seguintes:

| Tipo de Relacionamento  |      | Descri√ß√£o                                                    |
| ----------------------- | ---- | ------------------------------------------------------------ |
| Um pra um - 1:1         | ü°™    | Um Objeto da Classe A se relacionar√° com apenas um Objeto da Classe B. |
| Um pra muitos - 1:N     | ü°™    | Um Objeto da Classe A se relacionar√° com muitos Objetos da Classe B. |
| Muitos pra muitos - N:M | ü°™    | Muitos Objetos da Classe A se relacionar√£o com muitos Objetos da Classe B. |

No Modelo Relacional todo Relacionamento √© **Unidirecional**, ou seja, **apenas a Tabela que possui a Chave Estrangeira acessa a outra Tabela**. No Relacionamento de Classes, existe a possibilidade do Relacionamento ser **Bidirecional**, ou seja, uma **Classe acessa a outra e vice-versa, independente de possuir ou n√£o a Chave Estrangeira**.

Em um Relacionamento **Bidirecional**, precisamos definir um atributo na Classe M√£e da rela√ß√£o, que ser√° utilizado apenas para exibir os Objetos associados na Classe Filha. Esse atributo √© chamado de **Propriedade de Navega√ß√£o**.

Depois de criar o Relacionamento entre as Classes e executar o projeto Blog Pessoal, veremos que ser√° criado no SQL a Rela√ß√£o entre as tabelas **tb_postagens** e **tb_temas** Unidirecional. Veja abaixo como ficar√° a estrutura da nossa tabela atrav√©s do **Diagrama de Model e Relacionamentos (DER)**:

```mermaid
erDiagram
    Tema |o--o{ Postagem : Classifica
    Tema {
        BIGINT Id PK
        VARCHAR(255) Descricao
    }
    Postagem {
       	BIGINT Id PK
        VARCHAR(100) Titulo
        VARCHAR(1000) Texto
       	DATETIMEOFFSET Data
        BIGINT TemaId FK
    }
```

Como o Entity Framework faz o mapeamento das Tabelas em Objetos, caso o Relacionamento Bidirecional esteja habilitado, a Rela√ß√£o funcionar√° independente do Banco de Dados ser Unidirecional.

Vamos construir o Relacionamento Bidirecional (1:N) entre as nossas Classes Tema e Postagem como veremos a seguir. 

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/ef/core/modeling/relationships" target="_blank"><b>Documenta√ß√£o: Relacionamentos entre Classes Model</b></a></div>

<br />

<h2>üë£ Passo 01 - Registrar o Servi√ßo Newtonsoft.Json</h2>



Vamos registrar o Pacote **Newtonsoft.Json** como um servi√ßo na Classe **Program**. Este pacote tem a fun√ß√£o de configurar e formatar Objetos JSON. Como vamos trabalhar com Relacionamentos, executaremos muitos processos de **Serializa√ß√£o e Desserializa√ß√£o** de Objetos JSON, onde um Objeto estar√° dentro de outro. Esse processo causa um efeito colateral de loop infinito de Objetos JSON, onde um Objeto exibe o outro Objeto infinitamente. O Pacote **Newtonsoft.Json** evita este efeito colateral, impedindo a repeti√ß√£o infinita de Objetos.

> A **Serializa√ß√£o** √© o processo de converter um objeto em uma sequ√™ncia linear de bytes que podem ser armazenados ou transferidos;
>
> A **Desserializa√ß√£o** √© o processo de convers√£o de uma sequ√™ncia previamente serializada de bytes em um objeto;
>
> Ent√£o se voc√™ quiser armazenar um objeto *(ou v√°rios objetos)* em mem√≥ria para posterior recupera√ß√£o, voc√™ armazena a sa√≠da da serializa√ß√£o, e, na pr√≥xima vez que voc√™ quiser ler os objetos, voc√™ chama os m√©todos da desserializa√ß√£o, e seu objeto √© recriado exatamente como anteriormente.
>
> Da mesma forma, se voc√™ quiser enviar um objeto para um aplicativo em execu√ß√£o em outro computador, voc√™ estabelece uma conex√£o de rede, serializa o objeto antes de enviar e desserializa o objeto na aplica√ß√£o remota. 

1. Abra a Classe **Program**;
2. Localize a linha indicada abaixo:

 <div align="left"><img src="https://i.imgur.com/D5Ka2sO.png" title="source: imgur.com" /></div>

4. Troque a linha indicada acima, pelo trecho de c√≥digo abaixo:

```c#
 // Add Controller Class
builder.Services.AddControllers()
	.AddNewtonsoftJson(options =>
    {
    	options.SerializerSettings.ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;
    }
);builder.Services.AddTransient<IValidator<Tema>, TemaValidator>();
```

5. A imagem abaixo, mostra como ficar√° o trecho com a nova linha:

 <div align="left"><img src="https://i.imgur.com/BtL2Zbz.png" title="source: imgur.com" /></div>

Vamos entender o c√≥digo:

**Linhas 21 a 26:** Registra o Pacote **Newtonsoft.Json** como um servi√ßo na Classe **Program**.

**Linha 24:** Esta linha define a Propriedade **ReferenceLoopHandling** como **Ignore**, para que os valores de loop sejam exclu√≠dos da serializa√ß√£o ao inv√©s de gerar uma exce√ß√£o.

Existem outras op√ß√µes e propriedades dentro do Pacote **Newtonsoft.Json**. Para mais detalhes, consulte a documenta√ß√£o nos links abaixo.

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://www.newtonsoft.com/json/help/html/Introduction.htm" target="_blank"><b>Documenta√ß√£o: PacoteNewtonsoft.Json</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://www.newtonsoft.com/json/help/html/ReferenceLoopHandlingIgnore.htm#!" target="_blank"><b>Documenta√ß√£o: Propriedade ReferenceLoopHandling</b></a></div>

<br />

Veja o c√≥digo completo da Classe **Program** abaixo:

```c#

using blogpessoal.Data;
using blogpessoal.Model;
using blogpessoal.Service.Implements;
using blogpessoal.Service;
using blogpessoal.Validator;
using FluentValidation;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // Add services to the container.

            // Add Controller Class
            builder.Services.AddControllers()
                .AddNewtonsoftJson(options =>
                {
                    options.SerializerSettings.ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;
                }
            );

            // Conex√£o com o Banco de dados
            var connectionString = builder.Configuration.
                    GetConnectionString("DefaultConnection");

            builder.Services.AddDbContext<AppDbContext>(options =>
                options.UseSqlServer(connectionString)
            );

            // Valida√ß√£o das Entidades
            builder.Services.AddTransient<IValidator<Postagem>, PostagemValidator>();
            builder.Services.AddTransient<IValidator<Tema>, TemaValidator>();

            // Registrar as Classes e Interfaces Service
            builder.Services.AddScoped<IPostagemService, PostagemService>();

            // Learn more about configuring Swagger/OpenAPI
            // at https://aka.ms/aspnetcore/swashbuckle

            builder.Services.AddEndpointsApiExplorer();
            builder.Services.AddSwaggerGen();

            // Configura√ß√£o do CORS
            builder.Services.AddCors(options => {
                options.AddPolicy(name: "MyPolicy",
                    policy =>
                    {
                        policy.AllowAnyOrigin()
                        .AllowAnyHeader()
                        .AllowAnyMethod();
                    });
            });

            var app = builder.Build();

            // Criar o Banco de dados e as tabelas Automaticamente
            using (var scope = app.Services.CreateAsyncScope())
            {
                var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                dbContext.Database.EnsureCreated();

            }

            app.UseDeveloperExceptionPage();

            // Configure the HTTP request pipeline.
            if (app.Environment.IsDevelopment())
            {
                app.UseSwagger();
                app.UseSwaggerUI();
            }

            app.UseCors("MyPolicy");

            app.UseAuthorization();

            app.MapControllers();

            app.Run();
        }
    }
}
```

<br />

<h2>üë£ Passo 02 - Criar o Atributo Tema na Classe Postagem</h2>



A Classe Postagem ser√° o lado N:1, ou seja, **Muitas Postagens podem ter apenas Um Tema**. Para criar a Rela√ß√£o vamos inserir depois do √∫ltimo atributo da Classe **Postagem** (Texto), a linha destacada em amarelo na imagem abaixo:

<div align="left"><img src="https://i.imgur.com/kOWtWbC.png" title="source: imgur.com" /></div>

**Linha 21:** Ser√° criado um Objeto da Classe Tema, que receber√° os dados do Tema associado ao Objeto da Classe Postagem. Este Objeto representa a Chave Estrangeira da Tabela **tb_postagens (TemaId)**.

Note que ao lado do Objeto **Tema**, foi adicionado uma interroga√ß√£o (**?**). Esta interroga√ß√£o indica que o Objeto Tema, pode ser nulo (null), ou seja, um Objeto Postagem pode ter um ou nenhum tema associado. 

Veja abaixo o c√≥digo completo da **Classe Model Postagem**:

```c#
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;

namespace blogpessoal.Model
{
    public class Postagem : Auditable
    {

        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public long Id { get; set; }

        [Column(TypeName = "varchar")]
        [StringLength(100)]
        public string Titulo { get; set; } = string.Empty;

        [Column(TypeName = "varchar")]
        [StringLength(1000)]
        public string Texto { get; set; } = string.Empty;

        public virtual Tema? Tema { get; set; }

    }
}
```

<br />

<h2>üë£ Passo 03 - Criar o Atributo Postagem na Classe Tema</h2>



A Classe Tema ser√° o lado 1:N, ou seja, **Um Tema pode ter Muitas Postagens**. Para criar a Rela√ß√£o vamos inserir depois do √∫ltimo atributo da Classe Tema (Descricao), o trecho de c√≥digo destacado em amarelo na figura abaixo:

<div align="left"><img src="https://i.imgur.com/XeZs95q.png" title="source: imgur.com" /></div>

**Linha 18:** A Anota√ß√£o **[JsonIgnore, InverseProperty("Tema")]** indica que uma parte do JSON ser√° ignorado, ou seja, como a Rela√ß√£o  entre as Classes ser√° do tipo Bidirecional, ao listar o Objeto Tema  numa consulta, por exemplo, o Objeto Postagem, que ser√° criado na linha 19,  ser√° exibido como um **"Sub Objeto"** do Objeto Tema, como mostra a figura abaixo, devido ao Relacionamento que foi criado.

```json
{
	"id": 1,
	"descricao": "Tema 01",
	"postagem": [
		{
			"id": 1,
			"titulo": "Postagem 01",
			"texto": "Texto da minha postagem 01",
			"data": "2023-06-08T23:28:57.2305447",
			"temaId": 1
		},
		{
			"id": 3,
			"titulo": "Postagem 03",
			"texto": "Texto da minha postagem 03",
			"data": "2023-06-09T00:04:27.3084565",
			"temaId": 1
		}
	]
}
```

Ao exibir o Objeto Postagem, o Objeto Tema ser√° exibido novamente e na sequ√™ncia Postagem ser√° exibido novamente,  criando um looping infinito dentro do JSON, devido a rela√ß√£o  Bidirecional. Para impedir o loop infinito e o travamento da nossa  aplica√ß√£o (Vide a imagem abaixo com o erro que ser√° exibido no  Insomnia), utilizamos anota√ß√£o **[JsonIgnore, InverseProperty("Tema")]** para exibir o Objeto da Classe Tema apenas uma vez, interrompendo a repeti√ß√£o.

<div align="center"><img src="https://i.imgur.com/LChpd5m.png" title="source: imgur.com" /></div>

A Propriedade **InverseProperty** foi utilizada porque a Classe Postagem ter√° 2 Relacionamentos (Tema e futuramente User). Para identificar de qual relacionamento estamos falando, utilizamos a propriedade **InverseProperty** para indicar a **Entidade Inversa da Rela√ß√£o**.

**Linha 19:** Ser√° criado o atributo **Postagem**, da Classe Postagem, que ser√° utilizado para criar a rela√ß√£o Bidirecional. Este atributo ser√° uma Collection criada a partir da Interface **ICollection** (Interface base para gera√ß√£o de Collections, ou seja, uma Abstra√ß√£o), contendo Objetos da Classe **Postagem**, que receber√° a lista de postagens associadas a cada Objeto da Classe Tema. Este Objeto √© uma **Propriedade de Navega√ß√£o** do Entity Framework.

Note que ao lado do Objeto **Postagem**, foi adicionado uma interroga√ß√£o (**?**). Esta interroga√ß√£o indica que o Objeto Postagem, pode ser nulo (null), ou seja, um Objeto Tema pode ter uma, muitas, ou nenhuma Postagem associada. 

Veja abaixo o c√≥digo completo da **Classe Model Tema**:

```c#
using Newtonsoft.Json;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace blogpessoal.Model
{
    public class Tema
    {

        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public long Id { get; set; }

        [Column(TypeName = "varchar")]
        [StringLength(255)]
        public string Descricao { get; set; } = string.Empty;

        [JsonIgnore, InverseProperty("Tema")]
        public virtual ICollection<Postagem>? Postagem { get; set; }

    }
}
```

<br />


| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o Relacionamento entre as Classes. Observe que ap√≥s habilitar o Relacionamento entre Classes, novas importa√ß√µes de Classes ser√£o necess√°rias nas primeiras linhas da Classe Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://www.newtonsoft.com/json/help/html/PropertyJsonIgnore.htm" target="_blank"><b>Documenta√ß√£o: Propriedade JsonIgnore</b></a></div>

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://www.entityframeworktutorial.net/code-first/inverseproperty-dataannotations-attribute-in-code-first.aspx" target="_blank"><b>Documenta√ß√£o: Propriedade InverseProperty</b></a></div>

<br />

<h2>üë£ Passo 04 - Criar o Relacionamento na Classe AppDbContext</h2>



Vamos criar o Relacionamento entre as Classes **Tema e Postagem**, na Classe **AppDbContext**, para gerar as tabelas **tb_temas** e **tb_postagens** no Banco de dados com o relacionamento:

1. Abra a Classe **AppDbContext**, localizada na pasta **Data**;
2. Localize o M√©todo **OnModelCreating(ModelBuilder modelBuilder)**, indicado na imagem abaixo:

<div align="left"><img src="https://i.imgur.com/9aumOjn.png" title="source: imgur.com" /></div>

4. Adicione a linha de c√≥digo abaixo dentro do M√©todo **OnModelCreating(ModelBuilder modelBuilder)**:

```c#
 _ = modelBuilder.Entity<Postagem>()
          .HasOne(_ => _.Tema)
          .WithMany(t => t.Postagem)
          .HasForeignKey("TemaId")
          .OnDelete(DeleteBehavior.Cascade);
```

5. A imagem abaixo, mostra como ficar√° o M√©todo com as novas linhas:

 <div align="left"><img src="https://i.imgur.com/px6bVr4.png" title="source: imgur.com" /></div>

Vamos entender o c√≥digo:

**Linhas 18 a 22:** Definimos o Relacionamento Bidirecional entre as Classes Tema e Postagem.

**Linha 18:** Escolhemos configurar o Relacionamento a partir da Classe Entidade Filha. Por isso selecionamos a Model Postagem na instru√ß√£o **modelBuilder.Entity<Postagem>()**. 

**Linha 19:** Atrav√©s do M√©todo **HasOne(_ => _.Tema)** especificamos que a Entidade Postagem ter√° um Atributo chamado **Tema**, Objeto da Classe Tema. Esse Objeto representa a Chave Estrangeira. Na sequ√™ncia, precisamos configurar a outra ponta do relacionamento, a Classe Model Tema. 

**Linha 20:** Atrav√©s do M√©todo **WithMany(t => t.Postagem)** especificamos que a classe Tema ter√° um Atributo, que ser√° uma Collection, que armazenar√° diversos Objetos da Classe Postagem, associados ao Objeto da Classe Tema. Na pr√°tica, o M√©todo **WithMany()** indica qual Atributo ser√° a **Propriedade de Navega√ß√£o da Classe Tema**. 

**Linha 21:** Atrav√©s do M√©todo **HasForeignKey("TemaId")** especificamos o nome do atributo, que ser√° a Chave Estrangeira na tabela **tb_postagens**. 

**Linha 22:** Os relacionamentos entre Entidades geralmente dependem da exist√™ncia de outra Entidade, por exemplo, o relacionamento **Tema ü°™ Postagem**, sem um Objeto Tema associado, a Entidade Postagem n√£o tem nenhum significado pr√≥prio, se tornando o que chamamos de **Objeto √ìrf√£o** (Orphan Object). **Quando exclu√≠mos um Objeto da Entidade Tema, todos os Objetos da Entidade Postagem associadas ao Tema exclu√≠do tamb√©m devem ser exclu√≠dos**, entretanto, o inverso n√£o √© verdadeiro. **"Cascatear" (cascade)**, √© a maneira de conseguirmos este efeito no Relacionamento. Quando  executamos alguma a√ß√£o na Entidade Tema, a mesma a√ß√£o ser√° aplicada √†  Entidade associada em Postagem.

- **OnDelete(DeleteBehavior.Cascade):** O "cascateamento" foi habilitado apenas  na opera√ß√£o Delete, ou seja, apenas quando um Objeto da Classe Tema for  apagado, todos os Objetos da Classe Postagem associados ao Tema tamb√©m  ser√£o apagados. O Inverso n√£o √© verdadeiro.

Veja o c√≥digo completo da Classe **AppDbContext** abaixo:

```c#
using blogpessoal.Model;
using Microsoft.EntityFrameworkCore;

namespace blogpessoal.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options)
        {

        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.Entity<Postagem>().ToTable("tb_postagens");
            modelBuilder.Entity<Tema>().ToTable("tb_temas");

            // Relacionamento Postagem -> Tema
            _ = modelBuilder.Entity<Postagem>()
                .HasOne(_ => _.Tema)
                .WithMany(t => t.Postagem)
                .HasForeignKey("TemaId")
                .OnDelete(DeleteBehavior.Cascade);

        }

        // Registro das Entidades
        public DbSet<Postagem> Postagens { get; set; } = null!;
        public DbSet<Tema> Temas { get; set; } = null!;

        public override Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
        {
            var insertedEntries = this.ChangeTracker.Entries()
                                   .Where(x => x.State == EntityState.Added)
                                   .Select(x => x.Entity);

            foreach (var insertedEntry in insertedEntries)
            {
                //Se uma propriedade da Classe Auditable estiver sendo criada. 
                if (insertedEntry is Auditable auditableEntity)
                {
                    auditableEntity.Data = DateTimeOffset.Now;
                }
            }

            var modifiedEntries = ChangeTracker.Entries()
                       .Where(x => x.State == EntityState.Modified)
                       .Select(x => x.Entity);

            foreach (var modifiedEntry in modifiedEntries)
            {
                //Se uma propriedade da Classe Auditable estiver sendo atualizada.  
                if (modifiedEntry is Auditable auditableEntity)
                {
                    auditableEntity.Data = DateTimeOffset.Now;
                }
            }

            return base.SaveChangesAsync(cancellationToken);
        }

    }
}
```

<br />

<div align="left"><img src="https://i.imgur.com/wHTDfQ2.png" title="source: imgur.com" width="4%"/> <a href="https://learn.microsoft.com/pt-br/ef/core/modeling/relationships" target="_blank"><b>Documenta√ß√£o: Relacionamentos entre Classes Model</b></a></div>

<br />

<h2>üë£ Passo 05 - Apagar o Banco de dados</h2>



Antes de criarmos a tabela **tb_temas** e os respectivos relacionamentos, precisamos apagar o Banco de dados **db_blogpessoal**, porque o **ASP.NET** n√£o consegue atualizar e/ou criar tabelas, depois que uma tabela foi criada no banco de dados. Vamos apagar o Banco de dados **db_blogpessoal**:

1. Pare o projeto, caso ele esteja em execu√ß√£o.
2. Abra o **SQL Server Management Studio** e conecte-se com o **SQL Server**.
3. Clique com o bot√£o direito do mouse sobre o Banco de dados **db_blogpessoal** e no menu que ser√° aberto, clique na op√ß√£o **Excluir**, como mostra a imagem abaixo:

 <div align="center"><img src="https://i.imgur.com/7jfcFDE.png" title="source: imgur.com" width="45%"/></div>

4. Na janela **Excluir Objeto**, clique no bot√£o **OK** para confirmar.

 <div align="center"><img src="https://i.imgur.com/3DuNflw.png" title="source: imgur.com" /></div>

5. Observe que o Banco de dados **db_blogpessoal** foi exclu√≠do!

 <div align="center"><img src="https://i.imgur.com/X08D6ci.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <div align="left"> **ATEN√á√ÉO:** *Ao excluir o Banco de dados, todos os dados cadastrados ser√£o perdidos!* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 06 - Executar o projeto</h2>



1. Para executarmos o Projeto, clique no bot√£o <img src="https://i.imgur.com/gPnfOVk.png" title="source: imgur.com" width="8%"/>**Run http**, na **Barra de Ferramentas Principal** (indicado em verde na imagem):

![Imagem 30](https://i.imgur.com/Ya4O50P.png)

2. Verifique na Tela do Console se o Banco e as 2 tabelas foram criadas, como mostra a imagem abaixo:

 <div align="center"><img src="https://i.imgur.com/ujspzZw.png" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 07 - Checar o Banco de dados</h2>



1. Volte para o **SQL Server Management Studio** e conecte-se com o **SQL Server**.
2. Para visualizar se o **Banco de Dados db_blogpessoal** e as **Tabelas tb_postagens e tb_temas com o Relacionamento** foram criados, na janela **Pesquisador de Objetos**, localizada no lado esquerdo da tela, selecione o servidor <img src="https://i.imgur.com/Uz7gUN4.png" title="source: imgur.com" />**localhost** e clique no bot√£o **Atualizar** <img src="https://i.imgur.com/w0H9RB6.png" title="source: imgur.com" />.

<div align="center"><img src="https://i.imgur.com/ij7yMYl.png" title="source: imgur.com" /></div>

3. Na mesma janela, clique no sinal de (**+**) ao lado do item **Banco de Dados**, na sequ√™ncia, clique no sinal de (**+**) ao lado do **Banco de Dados db_blogpessoal**, clique no sinal de (**+**) ao lado do item **Tabelas** e se tudo deu certo, veremos as tabelas **tb_postagens e tb_temas** criadas dentro do **Banco de Dados db_blogpessoal**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/OheMQLh.png" title="source: imgur.com" width="50%"/></div>

4. Observe que a **Chave Estrangeira TemaId** foi criada na tabela **tb_postagens**.
5. Crie um novo arquivo SQL **(SQLFile)**, insira as instru√ß√µes abaixo e execute a consulta para popular a tabela **tb_postagens** novamente.

```sql
USE db_blogpessoal;
GO

INSERT INTO tb_postagens (Titulo, Texto, Data)
VALUES ('Postagem 01', 'Texto da Postagem 01', SYSDATETIMEOFFSET());
INSERT INTO tb_postagens (Titulo, Texto, Data)
VALUES ('Postagem 02', 'Texto da Postagem 02', SYSDATETIMEOFFSET());
INSERT INTO tb_postagens (Titulo, Texto, Data)
VALUES ('Postagem 03 - Atualizado', 'Texto da Postagem 03 - Atualizado', SYSDATETIMEOFFSET());
GO

SELECT * FROM tb_postagens;
GO
```

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <div align="left"> **ATEN√á√ÉO:** *Lembre-se que as nossas tabelas est√£o vazias, logo teremos que persistir novos Objetos.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Pr√≥ximo passo: Implementar as **Classes TemaService e TemaController**.

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="5%"/> <a href="" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>